<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração - Seu App Financeiro</title>
    <link rel="stylesheet" href="../css/picnic.css">
    <link rel="stylesheet" href="../css/style.css">
    <!-- SDK PocketBase -->
    <script src="../js/pocketbase/dist/pocketbase.umd.js"></script>
</head>
<body>
    <!-- NAV: menu dinâmico igual ao index.html -->
    <nav>
        <a href="/" class="brand">
            <span>Planilha</span>
        </a>
        <input id="bmenub" type="checkbox" class="show">
        <label for="bmenub" class="burger pseudo button">menu</label>
        <div class="menu" id="menu-user">
            <a href="#" class="pseudo button icon-picture">Demo</a>
            <a href="../login.html" class="button icon-puzzle" id="loginBtn">Login</a>
            <a href="../registro.html" class="button icon-user" id="registerBtn">Registrar</a>
        </div>
    </nav>
    <!-- SECTION MAIN: conteúdo principal ocupando toda tela -->
    <section class="section section-light" style="min-height: 70vh; display: flex; align-items: center; justify-content: center;">
        <div class="container">
            <div style="text-align: left; margin-bottom: 2rem;">
                <a href="index.html" class="button">← Voltar ao Dashboard</a>
            </div>
            <h2 style="text-align: center; margin-bottom: 3rem;">Configuração do Dashboard</h2>
            <p style="text-align: center; margin-bottom: 3rem; max-width: 800px; margin-left: auto; margin-right: auto;">
                Configure sua conta para integrar com o Google Drive e selecione sua planilha de controle financeiro.
            </p>
            
            <!-- Grid com os dois cartões de configuração -->
            <div style="max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 2rem;">
                <!-- Cartão 1: Autorização Google Drive -->
                <div id="google-auth-card" class="solution-card" style="display: flex; flex-direction: column; justify-content: space-between; min-height: 200px;">
                    <div>
                        <h3>Autorização Google Drive</h3>
                        <p>Autorize o acesso ao Google Drive. Após a autorização, uma planilha template será automaticamente copiada para o seu Drive, pronta para uso.</p>
                    </div>
                    <div style="margin-top: auto; padding-top: 1.5rem;">
                        <button id="google-auth-button" class="button primary large" style="width: 100%;" disabled>
                            Carregando...
                        </button>
                    </div>
                </div>
                
                <!-- Cartão 2: Seleção da Planilha -->
                <div class="solution-card" style="display: flex; flex-direction: column; justify-content: space-between; min-height: 200px;">
                    <div>
                        <h3>Gerenciar Planilha</h3>
                        <p>Selecione uma planilha existente ou copie novamente a planilha template para os lançamentos financeiros.</p>
                    </div>
                    <div style="margin-top: auto; padding-top: 1.5rem;">
                        <button class="button primary large" style="width: 100%;" id="selectSheetBtn">
                            Selecionar Planilha
                        </button>
                        <button class="button secondary" style="flex: 1; min-width: 150px;" id="provisionSheetBtn">
                            Copiar Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal para seleção de planilha -->
    <div class="modal" id="sheetsModal">
        <input type="checkbox" id="modal_sheets">
        <label for="modal_sheets" class="overlay" id="modalOverlay"></label>
        <article>
            <header>
                <h3>Selecionar Planilha Google Sheets</h3>
                <label for="modal_sheets" class="close">&times;</label>
            </header>
            <section class="content" id="modalContent">
                <div id="loadingState" style="text-align: center; padding: 2rem;">
                    <p>Carregando suas planilhas...</p>
                </div>
                <div id="errorState" style="display: none; text-align: center; padding: 2rem;">
                    <p id="errorMessage" style="color: #e74c3c;">Erro ao carregar planilhas.</p>
                    <button class="button" onclick="loadGoogleSheets()">Tentar Novamente</button>
                </div>
                <div id="sheetsListState" style="display: none;">
                    <p>Selecione uma planilha da lista abaixo:</p>
                    <div id="sheetsList" style="max-height: 300px; overflow-y: auto; margin: 1rem 0;">
                        <!-- Lista de planilhas será inserida aqui -->
                    </div>
                </div>
            </section>
            <footer>
                <button class="button" id="cancelBtn">Cancelar</button>
                <button class="button primary" id="confirmBtn" style="display: none;">Confirmar Seleção</button>
            </footer>
        </article>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Seu App Financeiro. Todos os direitos reservados.</p>
        </div>
        <p>
            <small>Produzido por
                <a href="https://www.ehtudo.app">Eh!Tudo.app</a></small>
        </p>
    </footer>
    <!-- Script PocketBase e módulos da aplicação -->
    <script src="../js/pocketbase/dist/pocketbase.umd.js"></script>
    <script type="module">
        import apiConfig from '../js/api-config.js';
        // Inicializa o PocketBase globalmente antes dos módulos
        window.pb = new PocketBase(apiConfig.getBaseURL());
    </script>
    <script src="../js/configuracao.js" type="module"></script>
    <script src="../js/dashboard-auth.js" type="module"></script>
    
    <!-- Script para funcionalidade de seleção de planilha -->
    <script>
        let selectedSheetId = null;
        let selectedSheetName = null;

        // Inicialização quando DOM carregado
        document.addEventListener('DOMContentLoaded', function() {
            const selectSheetBtn = document.getElementById('selectSheetBtn');
            const provisionSheetBtn = document.getElementById('provisionSheetBtn');
            const modal = document.getElementById('sheetsModal');
            const modalCheckbox = document.getElementById('modal_sheets');
            const cancelBtn = document.getElementById('cancelBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const modalOverlay = document.getElementById('modalOverlay');

            // Abrir modal ao clicar no botão
            selectSheetBtn.addEventListener('click', function() {
                openSheetsModal();
            });

            // Provisionar template manualmente
            provisionSheetBtn.addEventListener('click', function() {
                provisionTemplate();
            });

            // Fechar modal ao clicar em cancelar ou overlay
            cancelBtn.addEventListener('click', closeSheetsModal);
            modalOverlay.addEventListener('click', closeSheetsModal);

            // Confirmar seleção
            confirmBtn.addEventListener('click', function() {
                if (selectedSheetId) {
                    saveSelectedSheet();
                }
            });
        });

        function openSheetsModal() {
            const modalCheckbox = document.getElementById('modal_sheets');
            modalCheckbox.checked = true;
            
            // Reset modal state
            resetModalState();
            
            // Carregar planilhas
            loadGoogleSheets();
        }

        function closeSheetsModal() {
            const modalCheckbox = document.getElementById('modal_sheets');
            modalCheckbox.checked = false;
            selectedSheetId = null;
            selectedSheetName = null;
        }

        function resetModalState() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('sheetsListState').style.display = 'none';
            document.getElementById('confirmBtn').style.display = 'none';
            selectedSheetId = null;
            selectedSheetName = null;
        }

        async function loadGoogleSheets() {
            try {
                resetModalState();

                const response = await fetch('/list-google-sheets', {
                    method: 'GET',
                    headers: {
                        'Authorization': pb.authStore.token,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                console.log('Planilhas carregadas:', data);
                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao carregar planilhas');
                }

                if (data.success && data.sheets) {
                    displaySheetsList(data.sheets);
                } else {
                    throw new Error('Resposta inválida do servidor');
                }

            } catch (error) {
                console.error('Erro ao carregar planilhas:', error);
                showError(error.message);
            }
        }

        function displaySheetsList(sheets) {
            const sheetsList = document.getElementById('sheetsList');
            
            if (sheets.length === 0) {
                sheetsList.innerHTML = '<p style="text-align: center; color: #666;">Nenhuma planilha encontrada. Crie uma planilha no Google Sheets primeiro.</p>';
            } else {
                sheetsList.innerHTML = sheets.map(sheet => `
                    <div class="sheet-item" style="border: 1px solid #ddd; padding: 1rem; margin: 0.5rem 0; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;" 
                         onclick="selectSheet('${sheet.id}', '${escapeHtml(sheet.name)}')"
                         data-sheet-id="${sheet.id}">
                        <strong>${escapeHtml(sheet.name)}</strong>
                        ${sheet.modifiedTime ? `<small style="display: block; color: #666; margin-top: 0.25rem;">Modificada em: ${formatDate(sheet.modifiedTime)}</small>` : ''}
                    </div>
                `).join('');
            }

            // Mostrar lista
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('sheetsListState').style.display = 'block';
        }

        function selectSheet(sheetId, sheetName) {
            // Remove seleção anterior
            document.querySelectorAll('.sheet-item').forEach(item => {
                item.style.backgroundColor = '';
                item.style.borderColor = '#ddd';
            });

            // Adiciona seleção atual
            const selectedItem = document.querySelector(`[data-sheet-id="${sheetId}"]`);
            if (selectedItem) {
                selectedItem.style.backgroundColor = '#e3f2fd';
                selectedItem.style.borderColor = '#2196f3';
            }

            selectedSheetId = sheetId;
            selectedSheetName = sheetName;
            
            // Mostrar botão confirmar
            document.getElementById('confirmBtn').style.display = 'inline-block';
        }

        async function saveSelectedSheet() {
            if (!selectedSheetId) return;

            try {
                // Mostrar loading no botão
                const confirmBtn = document.getElementById('confirmBtn');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = 'Salvando...';
                confirmBtn.disabled = true;

                const response = await fetch('/save-sheet-id', {
                    method: 'POST',
                    headers: {
                        'Authorization': pb.authStore.token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sheet_id: selectedSheetId,
                        sheet_name: selectedSheetName
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao salvar planilha');
                }

                if (data.success) {
                    // Sucesso - fechar modal e mostrar feedback
                    closeSheetsModal();
                    showSuccessMessage(`Planilha "${selectedSheetName}" selecionada com sucesso!`);
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }

            } catch (error) {
                console.error('Erro ao salvar planilha:', error);
                alert('Erro ao salvar planilha: ' + error.message);
                
                // Restaurar botão
                const confirmBtn = document.getElementById('confirmBtn');
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            }
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('sheetsListState').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }

        async function provisionTemplate() {
            const provisionBtn = document.getElementById('provisionSheetBtn');
            const originalText = provisionBtn.textContent;
            
            try {
                // Mostrar loading
                provisionBtn.textContent = 'Copiando...';
                provisionBtn.disabled = true;

                const response = await fetch('/provision-sheet', {
                    method: 'POST',
                    headers: {
                        'Authorization': pb.authStore.token,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erro ao copiar template');
                }

                if (data.success) {
                    if (data.action === 'existing') {
                        showSuccessMessage('Você já possui uma planilha configurada!');
                    } else {
                        showSuccessMessage(`Template copiado com sucesso! Planilha "${data.sheet_name}" criada no seu Google Drive.`);
                    }
                } else {
                    throw new Error(data.message || 'Erro desconhecido');
                }

            } catch (error) {
                console.error('Erro ao provisionar template:', error);
                showErrorMessage('Erro ao copiar template: ' + error.message);
            } finally {
                // Restaurar botão
                provisionBtn.textContent = originalText;
                provisionBtn.disabled = false;
            }
        }

        function showSuccessMessage(message) {
            showMessage(message, '#4caf50', '#ffffff');
        }

        function showErrorMessage(message) {
            showMessage(message, '#f44336', '#ffffff');
        }

        function showMessage(message, backgroundColor, textColor) {
            // Criar elemento de feedback temporário
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed; 
                top: 20px; 
                right: 20px; 
                background: ${backgroundColor}; 
                color: ${textColor}; 
                padding: 1rem 1.5rem; 
                border-radius: 4px; 
                z-index: 9999; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 400px;
                word-wrap: break-word;
                font-size: 14px;
                line-height: 1.4;
            `;
            feedback.textContent = message;
            document.body.appendChild(feedback);
        }
            // Remover após 5 segundos para mensagens mais longas
        function showSuccessMessage(message) {
            // Criar elemento de feedback temporário
            const feedback = document.createElement('div');
            feedback.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 1rem; border-radius: 4px; z-index: 9999; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
            feedback.textContent = message;
            document.body.appendChild(feedback);

            // Remover após 3 segundos
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('pt-BR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }
    
    </script>
</body>
</html>