<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Seu App Financeiro</title>
    <link rel="stylesheet" href="../css/picnic.css">
    <link rel="stylesheet" href="../css/style.css">
    <!-- SDK PocketBase -->
    <script src="../js/pocketbase/dist/pocketbase.umd.js"></script>
</head>

<body>
    <!-- NAV: menu dinâmico igual ao index.html -->
    <nav>
        <a href="/" class="brand">
            <span>Planilha</span>
        </a>
        <input id="bmenub" type="checkbox" class="show">
        <label for="bmenub" class="burger pseudo button">menu</label>
        <div class="menu" id="menu-user">
            <a href="#" class="pseudo button icon-picture">Demo</a>
            <a href="../login.html" class="button icon-puzzle" id="loginBtn">Login</a>
            <a href="../registro.html" class="button icon-user" id="registerBtn">Registrar</a>
        </div>
    </nav>
    <!-- SECTION MAIN: conteúdo principal ocupando toda tela -->
    <section class="section section-light"
        style="min-height: 70vh; display: flex; align-items: center; justify-content: center;">
        <div class="container text-center">
            <h2>Bem-vindo ao seu Dashboard!</h2>
            <p>Aqui você pode visualizar e gerenciar suas finanças de forma simples e rápida.</p>
            <!-- Adicione aqui os componentes do dashboard -->
            <div style="margin-top: 2rem;">
                <a href="configuracao.html" id="configBtn" class="button primary" style="display: none;">⚙️ Configurar
                    Integração</a>
            </div>
        </div>
    </section>

    <!-- SECTION FORM: Formulário de lançamento de despesas -->
    <section class="section" style="padding: 2rem 0;">
        <div class="container">
            <div class="row">
                <div class="col-md-8 col-lg-6 mx-auto">
                    <div class="solution-card">
                        <h3 style="margin-bottom: 1.5rem;">Lançamento de Despesa/Receita</h3>
                        <form id="expenseForm">
                            <fieldset>
                                <!-- Data e Hora -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseDate">Data:</label>
                                    <input type="datetime-local" id="expenseDate" name="data" class="form-control"
                                        required>
                                </div>

                                <!-- Conta -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseAccount">Conta:</label>
                                    <input type="text" id="expenseAccount" name="conta" class="form-control"
                                        placeholder="Ex: Conta Corrente, Cartão de Crédito" required>
                                </div>

                                <!-- Valor com toggle de sinal -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseValue">Valor:</label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <button type="button" id="expenseSignBtn" class="button outline" aria-label="Alternar sinal"
                                            style="background-color: white; color: inherit; border: 1px solid #ccc; width: 2.5rem; text-align: center;">-</button>
                                        <input type="number" id="expenseValue" name="valor" class="form-control" step="0.01"
                                            min="0" placeholder="0,00" required>
                                        <input type="hidden" id="expenseSignValue" name="sinal" value="-">
                                    </div>
                                </div>

                                <!-- Descrição -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseDescription">Descrição:</label>
                                    <input type="text" id="expenseDescription" name="descricao" class="form-control"
                                        placeholder="Descrição da despesa" required>
                                </div>

                                <!-- Categoria -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseCategory">Categoria:</label>
                                    <select id="expenseCategory" name="categoria" class="form-control" required>
                                        <option value="">Outras</option>
                                    </select>
                                </div>

                                <!-- Orçamento -->
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label for="expenseBudget">Orçamento:</label>
                                    <input type="date" id="expenseBudget" name="orcamento" class="form-control"
                                        required>
                                </div>

                                <!-- Botões -->
                                <div class="form-group"
                                    style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                                    <button type="reset" class="button secondary">Limpar</button>
                                    <button type="submit" class="button primary">Salvar Despesa</button>
                                </div>
                            </fieldset>
                        </form>
                        <p style="margin-top: 1rem; color: #666; font-style: italic; text-align: center;">
                            Formulário temporariamente desabilitado
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Seu App Financeiro. Todos os direitos reservados.</p>
        </div>
        <p>
            <small>Produzido por
                <a href="https://www.ehtudo.app">Eh!Tudo.app</a></small>
        </p>
    </footer>
    <!-- Script PocketBase e módulos da aplicação -->
    <script type="module">
        import apiConfig from '../js/config/api-config.js';
        import { inicializarMenuUsuario } from '../js/menu-usuario.js';

        // Inicializa o PocketBase globalmente antes dos módulos
        window.pb = new PocketBase(apiConfig.getBaseURL());

        inicializarMenuUsuario();

        setTimeout(() => {
            import('../js/protecao-dashboard.js')
                .then(() => {
                    console.log('Módulo de proteção do dashboard carregado com sucesso.');
                })
                .catch(err => {
                    console.error('Erro ao carregar o módulo de proteção do dashboard:', err);
                });
        }, 100); // Aguarda 100 milissegundos para garantir que a autenticação seja verificada

        // Substitui verificação frontend por rota de configuração no servidor
        (async () => {
            const configBtn = document.getElementById('configBtn');
            if (!configBtn) return;
            try {
                const response = await fetch(`${apiConfig.getBaseURL()}/config-status`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${pb.authStore.token}`
                    }
                });
                if (!response.ok) throw new Error('Erro na requisição de configuração');
                const data = await response.json();
                // Exibe botão se configuração inválida ou campos faltando
                if (!data.validConfig) {
                    console.log('Configuração incompleta, campos faltando:', data.missing);
                    configBtn.style.display = '';
                }
            } catch (error) {
                console.error('Erro ao verificar configuração do Google:', error);
                configBtn.style.display = '';
            }
        })();
        // Controle de sinal de valor
        const expenseSignBtn = document.getElementById('expenseSignBtn');
        const expenseSignValue = document.getElementById('expenseSignValue');
        let currentSign = '-';
        function updateSign() {
            expenseSignBtn.textContent = currentSign;
            expenseSignBtn.style.color = currentSign === '+' ? 'green' : 'red';
            expenseSignValue.value = currentSign;
        }
        expenseSignBtn.addEventListener('click', () => {
            currentSign = currentSign === '+' ? '-' : '+';
            updateSign();
        });
        updateSign();
        // Define valores iniciais dos inputs de data e orçamento
        const expenseDateInput = document.getElementById('expenseDate');
        // Define data e hora atuais no horário local
        {
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const localDate = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
            const localTime = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            expenseDateInput.value = `${localDate}T${localTime}`;
        }
        const expenseBudgetInput = document.getElementById('expenseBudget');
        {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            expenseBudgetInput.value = firstDay.toISOString().slice(0,10);
        }
        // Popula categorias dinamicamente (mock a partir da aba 'Categorias')
        const categoriasMock = [
            { value: 'Alimentação', label: 'Alimentação' },
            { value: 'Transporte', label: 'Transporte' },
            { value: 'Moradia', label: 'Moradia' },
            { value: 'Saúde', label: 'Saúde' },
            { value: 'Educação', label: 'Educação' },
            { value: 'Lazer', label: 'Lazer' },
            { value: 'Vestuário', label: 'Vestuário' }        ];
        const categorySelect = document.getElementById('expenseCategory');
        categoriasMock.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat.value;
            opt.textContent = cat.label;
            categorySelect.appendChild(opt);
        });
    </script>
</body>

</html>