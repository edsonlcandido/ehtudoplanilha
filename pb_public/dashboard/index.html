<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Seu App Financeiro</title>
    <link rel="stylesheet" href="../css/picnic.css">
    <link rel="stylesheet" href="../css/style.css">
    <script src="../js/pocketbase/dist/pocketbase.umd.js"></script>
</head>

<body>
    <!-- NAV: menu din√¢mico igual ao index.html -->
    <nav>
        <a href="/" class="brand">
            <span>Planilha</span>
        </a>
        <input id="bmenub" type="checkbox" class="show">
        <label for="bmenub" class="burger pseudo button">menu</label>
        <div class="menu" id="menu-user">
            <a href="#" class="pseudo button icon-picture">Demo</a>
            <a href="../login.html" class="button icon-puzzle" id="loginBtn">Login</a>
            <a href="../registro.html" class="button icon-user" id="registerBtn">Registrar</a>
        </div>
    </nav>
    <!-- SECTION MAIN: conte√∫do principal ocupando toda tela -->
    <section class="section section-light"
        style="min-height: 70vh; display: flex; align-items: center; justify-content: center;">
        <div class="container text-center">
            <h2>Bem-vindo ao seu Dashboard!</h2>
            <p>Aqui voc√™ pode visualizar e gerenciar suas finan√ßas de forma simples e r√°pida.</p>
            
            <!-- Cards Financeiros -->
            <div id="financialCards" class="dashboard-cards" style="display: none;">
                <div class="financial-card receitas loading">
                    <div class="card-header">
                        <div class="card-icon">üí∞</div>
                        <h3 class="card-title">Receitas</h3>
                    </div>
                    <div class="card-value" id="receitasValue">R$ 0,00</div>
                    <div class="card-variation" id="receitasVariation">
                        <span class="variation-icon">üìà</span>
                        <span>+0,0% em rela√ß√£o ao m√™s anterior</span>
                    </div>
                </div>
                
                <div class="financial-card despesas loading">
                    <div class="card-header">
                        <div class="card-icon">üí∏</div>
                        <h3 class="card-title">Despesas</h3>
                    </div>
                    <div class="card-value" id="despesasValue">R$ 0,00</div>
                    <div class="card-variation" id="despesasVariation">
                        <span class="variation-icon">üìâ</span>
                        <span>+0,0% em rela√ß√£o ao m√™s anterior</span>
                    </div>
                </div>
                
                <div class="financial-card saldo loading">
                    <div class="card-header">
                        <div class="card-icon">üíµ</div>
                        <h3 class="card-title">Saldo</h3>
                    </div>
                    <div class="card-value" id="saldoValue">R$ 0,00</div>
                    <div class="card-variation" id="saldoVariation">
                        <span class="variation-icon">üìä</span>
                        <span>+0,0% em rela√ß√£o ao m√™s anterior</span>
                    </div>
                </div>
            </div>

            <!-- Adicione aqui os componentes do dashboard -->
            <div style="margin-top: 2rem;">
                <a href="configuracao.html" id="configBtn" class="button primary" style="display: none;">‚öôÔ∏è Configurar
                    Integra√ß√£o</a>
            </div>
        </div>
    </section>

    <!-- SECTION FORM: Formul√°rio de lan√ßamento de despesas -->
    <section class="section" style="padding: 2rem 0;">
        <div class="container">
            <div class="row">
                <div class="col-md-8 col-lg-6 mx-auto">
                    <div class="solution-card">
                        <h3 style="margin-bottom: 1.5rem;">Lan√ßamento de Despesa/Receita</h3>
                        <form id="expenseForm">
                            <fieldset>
                                <!-- Data e Hora -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseDate">Data:</label>
                                    <input type="datetime-local" id="expenseDate" name="data" class="form-control"
                                        required>
                                </div>

                                <!-- Conta -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseAccount">Conta:</label>
                                    <input type="text" id="expenseAccount" name="conta" class="form-control"
                                        placeholder="Ex: Conta Corrente, Cart√£o de Cr√©dito" required>
                                </div>

                                <!-- Valor com toggle de sinal -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseValue">Valor:</label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <button type="button" id="expenseSignBtn" class="button outline" aria-label="Alternar sinal"
                                            style="background-color: white; color: inherit; border: 1px solid #ccc; width: 2.5rem; text-align: center;">-</button>
                                        <input type="number" id="expenseValue" name="valor" class="form-control" step="0.01"
                                            min="0" placeholder="0,00" required>
                                        <input type="hidden" id="expenseSignValue" name="sinal" value="-">
                                    </div>
                                </div>

                                <!-- Descri√ß√£o -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseDescription">Descri√ß√£o:</label>
                                    <input type="text" id="expenseDescription" name="descricao" class="form-control"
                                        placeholder="Descri√ß√£o da despesa" required>
                                </div>

                                <!-- Categoria -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseCategory">Categoria:</label>
                                    <select id="expenseCategory" name="categoria" class="form-control" required>
                                        <option value="">Selecione uma categoria</option>
                                    </select>
                                </div>

                                <!-- Or√ßamento -->
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label for="expenseBudget">Or√ßamento:</label>
                                    <input type="date" id="expenseBudget" name="orcamento" class="form-control"
                                        required>
                                </div>
                                
                                <!-- Bot√µes -->
                                <div class="form-group"
                                    style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem;">
                                    <button type="reset" class="button secondary">Limpar</button>
                                    <button type="submit" class="button primary">Salvar Despesa</button>
                                </div>
                            </fieldset>
                        </form>
                        <p style="margin-top: 1rem; color: #666; font-style: italic; text-align: center;">
                            Formul√°rio temporariamente desabilitado
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Seu App Financeiro. Todos os direitos reservados.</p>
        </div>
        <p>
            <small>Produzido por
                <a href="https://www.ehtudo.app">Eh!Tudo.app</a></small>
        </p>
    </footer>
    <!-- Script PocketBase e m√≥dulos da aplica√ß√£o -->
    <script type="module">
        import apiConfig from '../js/config/api-config.js';
        import { inicializarMenuUsuario } from '../js/menu-usuario.js';
        import googleSheetsService from '../js/google/sheets-api.js';

        // Inicializa o PocketBase globalmente antes dos m√≥dulos
        window.pb = new PocketBase(apiConfig.getBaseURL());

        inicializarMenuUsuario();

        // Inicializa o servi√ßo Google Sheets
        googleSheetsService.init(window.pb);

        setTimeout(() => {
            import('../js/protecao-dashboard.js')
                .then(() => {
                    console.log('M√≥dulo de prote√ß√£o do dashboard carregado com sucesso.');
                })
                .catch(err => {
                    console.error('Erro ao carregar o m√≥dulo de prote√ß√£o do dashboard:', err);
                });
        }, 100); // Aguarda 100 milissegundos para garantir que a autentica√ß√£o seja verificada

        // Substitui verifica√ß√£o frontend por rota de configura√ß√£o no servidor
        (async () => {
            const configBtn = document.getElementById('configBtn');
            const financialCards = document.getElementById('financialCards');
            
            if (!configBtn) return;
            
            try {
                const response = await fetch(`${apiConfig.getBaseURL()}/config-status`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${pb.authStore.token}`
                    }
                });
                if (!response.ok) throw new Error('Erro na requisi√ß√£o de configura√ß√£o');
                const data = await response.json();
                
                // Exibe bot√£o se configura√ß√£o inv√°lida ou campos faltando
                if (!data.validConfig) {
                    console.log('Configura√ß√£o incompleta, campos faltando:', data.missing);
                    configBtn.style.display = '';
                } else {
                    // Se configura√ß√£o OK, carrega dados financeiros
                    await carregarDadosFinanceiros();
                    financialCards.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao verificar configura√ß√£o do Google:', error);
                configBtn.style.display = '';
            }
        })();

        // Fun√ß√£o para carregar dados financeiros
        async function carregarDadosFinanceiros() {
            try {
                console.log('Carregando dados financeiros...');
                const summary = await googleSheetsService.getFinancialSummary();
                
                if (summary.success) {
                    atualizarCardsFinanceiros(summary);
                } else {
                    console.error('Erro ao carregar dados financeiros:', summary.error);
                }
            } catch (error) {
                console.error('Erro ao carregar dados financeiros:', error);
                // Em caso de erro, mant√©m os cards com valores zerados
                removerLoadingCards();
            }
        }

        // Fun√ß√£o para atualizar os cards com os dados
        function atualizarCardsFinanceiros(data) {
            // Formatador de moeda brasileira
            const formatarMoeda = (valor) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(valor);
            };

            // Formatador de varia√ß√£o percentual
            const formatarVariacao = (variacao, tipo) => {
                const sinal = variacao >= 0 ? '+' : '';
                const icone = variacao > 0 ? 'üìà' : variacao < 0 ? 'üìâ' : 'üìä';
                const classe = variacao > 0 ? 'variation-positive' : 
                             variacao < 0 ? 'variation-negative' : 'variation-neutral';
                
                return {
                    texto: `${sinal}${variacao.toFixed(1)}% em rela√ß√£o ao m√™s anterior`,
                    classe: classe,
                    icone: icone
                };
            };

            // Atualizar Receitas
            document.getElementById('receitasValue').textContent = formatarMoeda(data.receitas);
            const receitasVar = formatarVariacao(data.variacaoReceitas, 'receitas');
            const receitasVariationEl = document.getElementById('receitasVariation');
            receitasVariationEl.className = `card-variation ${receitasVar.classe}`;
            receitasVariationEl.innerHTML = `
                <span class="variation-icon">${receitasVar.icone}</span>
                <span>${receitasVar.texto}</span>
            `;

            // Atualizar Despesas
            document.getElementById('despesasValue').textContent = formatarMoeda(data.despesas);
            const despesasVar = formatarVariacao(data.variacaoDespesas, 'despesas');
            const despesasVariationEl = document.getElementById('despesasVariation');
            despesasVariationEl.className = `card-variation ${despesasVar.classe}`;
            despesasVariationEl.innerHTML = `
                <span class="variation-icon">${despesasVar.icone}</span>
                <span>${despesasVar.texto}</span>
            `;

            // Atualizar Saldo
            document.getElementById('saldoValue').textContent = formatarMoeda(data.saldo);
            const saldoVar = formatarVariacao(data.variacaoSaldo, 'saldo');
            const saldoVariationEl = document.getElementById('saldoVariation');
            saldoVariationEl.className = `card-variation ${saldoVar.classe}`;
            saldoVariationEl.innerHTML = `
                <span class="variation-icon">${saldoVar.icone}</span>
                <span>${saldoVar.texto}</span>
            `;

            // Remover estado de loading
            removerLoadingCards();
            
            console.log('Cards financeiros atualizados com sucesso:', data);
        }

        // Fun√ß√£o para remover estado de loading dos cards
        function removerLoadingCards() {
            document.querySelectorAll('.financial-card.loading').forEach(card => {
                card.classList.remove('loading');
            });
        }

        // Controle de sinal de valor
        const expenseSignBtn = document.getElementById('expenseSignBtn');
        const expenseSignValue = document.getElementById('expenseSignValue');
        let currentSign = '-';
        function updateSign() {
            expenseSignBtn.textContent = currentSign;
            expenseSignBtn.style.color = currentSign === '+' ? 'green' : 'red';
            expenseSignValue.value = currentSign;
        }
        expenseSignBtn.addEventListener('click', () => {
            currentSign = currentSign === '+' ? '-' : '+';
            updateSign();
        });
        updateSign();

        // Define valores iniciais dos inputs de data e or√ßamento
        const expenseDateInput = document.getElementById('expenseDate');
        // Define data e hora atuais no hor√°rio local
        {
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const localDate = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
            const localTime = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            expenseDateInput.value = `${localDate}T${localTime}`;
        }
        const expenseBudgetInput = document.getElementById('expenseBudget');
        {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            expenseBudgetInput.value = firstDay.toISOString().slice(0,10);
        }


        // Carrega categorias diretamente da planilha (aba 'Categorias')
        async function carregarCategorias() {
            const categorySelect = document.getElementById('expenseCategory');
            if (!categorySelect) return;
            
            try {
                // Tenta buscar categorias da planilha
                const categorias = await googleSheetsService.getCategories();
                
                // Limpa op√ß√µes existentes, mantendo apenas a primeira
                while (categorySelect.options.length > 1) {
                    categorySelect.remove(1);
                }
                
                if (categorias && categorias.length > 0) {
                    // Adiciona as categorias da planilha
                    categorias.forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat;
                        opt.textContent = cat;
                        categorySelect.appendChild(opt);
                    });
                    console.log('Categorias carregadas da planilha:', categorias);
                } else {
                    // Se n√£o encontrou categorias, usa o fallback de categorias padr√£o
                    const categoriasPadrao = [
                        'Alimenta√ß√£o', 'Transporte', 'Moradia', 'Sa√∫de', 
                        'Educa√ß√£o', 'Lazer', 'Vestu√°rio', 'Outras'
                    ];
                    categoriasPadrao.forEach(cat => {
                        const opt = document.createElement('option');
                        opt.value = cat;
                        opt.textContent = cat;
                        categorySelect.appendChild(opt);
                    });
                    console.log('Usando categorias padr√£o (n√£o foi poss√≠vel carregar da planilha)');
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                // Em caso de erro, usa as categorias padr√£o
                const categoriasPadrao = [
                    'Alimenta√ß√£o', 'Transporte', 'Moradia', 'Sa√∫de', 
                    'Educa√ß√£o', 'Lazer', 'Vestu√°rio', 'Outras'
                ];
                categoriasPadrao.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    opt.textContent = cat;
                    categorySelect.appendChild(opt);
                });
            }
        }
        
        // Carrega as categorias ao iniciar a p√°gina
        carregarCategorias();


        // --- ENVIO DO FORMUL√ÅRIO PARA APENDAR NA PLANILHA DO GOOGLE ---
        const expenseForm = document.getElementById('expenseForm');
        if (expenseForm) {
            expenseForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.textContent;
                submitBtn.textContent = 'Enviando...';
                submitBtn.disabled = true;
                try {
                    // Coleta e prepara os dados do formul√°rio
                    const data = formatarData(document.getElementById('expenseDate').value);
                    const conta = document.getElementById('expenseAccount').value.trim();
                    const valorBase = parseFloat(document.getElementById('expenseValue').value);
                    const sinal = document.getElementById('expenseSignValue').value;
                    const valor = sinal === '-' ? -Math.abs(valorBase) : Math.abs(valorBase);
                    const descricao = document.getElementById('expenseDescription').value.trim();
                    const categoria = document.getElementById('expenseCategory').value.trim();
                    const orcamento = formatarDataOrcamento(document.getElementById('expenseBudget').value);

                    const entryData = {
                        data,
                        conta,
                        valor: valor.toFixed(2).replace('.', ','),
                        descricao,
                        categoria,
                        orcamento
                    };

                    // Chama o servi√ßo para apendar na planilha
                    const resultado = await googleSheetsService.addEntry(entryData);

                    if (resultado.success) {
                        mostrarMensagem('success', 'Lan√ßamento enviado com sucesso!');
                        limparCamposFormulario();
                    } else {
                        throw new Error(resultado.error || 'Erro ao enviar lan√ßamento');
                    }
                } catch (error) {
                    console.error('Erro ao enviar dados:', error);
                    mostrarMensagem('error', 'Erro ao enviar lan√ßamento: ' + (error.message || error));
                } finally {
                    submitBtn.textContent = originalBtnText;
                    submitBtn.disabled = false;
                }
            });
        }

        // Fun√ß√µes auxiliares
        function formatarData(dataHora) {
            // Converte 2025-08-01T14:30 para 01/08/2025
            const dt = new Date(dataHora);
            return `${String(dt.getDate()).padStart(2, '0')}/${String(dt.getMonth() + 1).padStart(2, '0')}/${dt.getFullYear()}`;
        }
        function formatarDataOrcamento(data) {
            // Converte 2025-08-01 para 2025-08
            return data.substring(0, 7);
        }
        function limparCamposFormulario() {
            document.getElementById('expenseAccount').value = '';
            document.getElementById('expenseValue').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseCategory').selectedIndex = 0;
            currentSign = '-';
            updateSign();
        }
        function mostrarMensagem(tipo, texto) {
            let msgEl = document.getElementById('feedback-message');
            if (!msgEl) {
                msgEl = document.createElement('div');
                msgEl.id = 'feedback-message';
                msgEl.style.position = 'fixed';
                msgEl.style.top = '70px';
                msgEl.style.right = '20px';
                msgEl.style.padding = '15px 20px';
                msgEl.style.borderRadius = '4px';
                msgEl.style.fontSize = '16px';
                msgEl.style.fontWeight = 'bold';
                msgEl.style.zIndex = '10000';
                document.body.appendChild(msgEl);
            }
            if (tipo === 'success') {
                msgEl.style.backgroundColor = '#4CAF50';
                msgEl.style.color = 'white';
            } else {
                msgEl.style.backgroundColor = '#F44336';
                msgEl.style.color = 'white';
            }
            msgEl.textContent = texto;
            msgEl.style.display = 'block';
            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 5000);
        }

        // Remove aviso de formul√°rio desabilitado
        const aviso = document.querySelector('.solution-card > p');
        if (aviso) aviso.style.display = 'none';
    </script>
</body>

</html>
