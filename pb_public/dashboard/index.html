<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Dashboard - Seu App Financeiro</title>
    <link rel="stylesheet" href="../css/picnic.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/responsive-tables.css">
    <script src="../js/pocketbase/dist/pocketbase.umd.js"></script>
    <style>
        body {
            max-width: 100vw;
            overflow-x: hidden;
        }
        
        /* Estilos globais para tabelas rol√°veis */
        .tabela-rolavel {
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            -webkit-overflow-scrolling: touch; /* Rolagem suave em iOS */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #ccc transparent; /* Firefox */
        }
        
        /* Estilos para os seletores de per√≠odo */
        .period-selectors {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .selector-container {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .selector-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .selector-group label {
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }
        
        .selector-group select {
            min-width: 150px;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: white;
        }
        
        .selector-group select:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        @media (max-width: 768px) {
            .selector-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .selector-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .selector-group select {
                min-width: auto;
                width: 100%;
            }
        }
        
        /* Garantir min-width nas tabelas dentro de cont√™ineres rol√°veis */
        .tabela-rolavel table {
            min-width: 600px;
            width: 100%;
        }
        
        /* Evitar que a tabela quebre o layout em telas pequenas */
        @media (max-width: 768px) {
            .container-tabela {
                position: relative;
                max-width: 100%;
                overflow: hidden;
            }
            
            .top-categories-container {
                max-width: 100%;
                margin: 0;
                padding: 0 10px;
            }
        }
    </style>
</head>

<body>
    <!-- NAV: menu din√¢mico igual ao index.html -->
    <nav>
        <a href="/" class="brand">
            <span>Planilha Eh Tudo</span>
        </a>
        <input id="bmenub" type="checkbox" class="show">
        <label for="bmenub" class="burger pseudo button">menu</label>
        <div class="menu" id="menu-user">
            <a href="#" class="pseudo button icon-picture">Demo</a>
            <a href="../login.html" class="button icon-puzzle" id="loginBtn">Login</a>
            <a href="../registro.html" class="button icon-user" id="registerBtn">Registrar</a>
        </div>
    </nav>
    <!-- SECTION MAIN: conte√∫do principal ocupando toda tela -->
    <section class="section section-light dashboard-main">
        <div class="container text-center">
            <h2>Bem-vindo ao seu Dashboard!</h2>
            <p>Aqui voc√™ pode visualizar e inserir lan√ßamentos de forma simples e r√°pida.</p>
            
            <!-- Seletor de Per√≠odo -->
            <div id="periodSelectors" class="period-selectors" style="display: none; margin-bottom: 2rem;">
                <div class="selector-container" style="display: flex; gap: 1rem; align-items: center; justify-content: center; flex-wrap: wrap;">
                    <div class="selector-group">
                        <label for="budgetSelector" style="margin-right: 0.5rem; font-weight: bold;">Or√ßamento:</label>
                        <select id="budgetSelector" class="form-control" style="min-width: 180px;">
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Cards Financeiros -->
            <div id="financialCards" class="dashboard-cards" style="display: none;">
                <div class="financial-card saldo loading">
                    <div class="card-header">
                        <div class="card-icon">üíµ</div>
                        <h3 class="card-title">Saldo</h3>
                    </div>
                <div class="card-value" id="saldoValue" style="display:flex; align-items:center; justify-content:flex-start;">R$ 0,00</div>
                </div>
                
                <div class="financial-card despesas loading">
                    <div class="card-header">
                        <div class="card-icon">üí∏</div>
                        <h3 class="card-title">Despesas</h3>
                    </div>
                <div class="card-value" id="despesasValue" style="display:flex; align-items:center; justify-content:space-between;">
                    <span id="despesasValueText">R$ 0,00</span>
                    <button type="button" id="toggleDespesas" class="toggle-eye" aria-label="Ocultar/Mostrar Despesas" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">
                        <span id="iconDespesas">üëÅÔ∏è</span>
                    </button>
                </div>
                    <div class="card-variation" id="despesasVariation">
                        <span class="variation-icon">üìâ</span>
                        <span>+0,0% em rela√ß√£o ao m√™s anterior</span>
                    </div>
                </div>
                
                <div class="financial-card receitas loading">
                    <div class="card-header">
                        <div class="card-icon">üí∞</div>
                        <h3 class="card-title">Receitas</h3>
                    </div>
                <div class="card-value" id="receitasValue" style="display:flex; align-items:center; justify-content:space-between;">
                    <span id="receitasValueText">R$ 0,00</span>
                    <button type="button" id="toggleReceitas" class="toggle-eye" aria-label="Ocultar/Mostrar Receitas" style="background:none;border:none;cursor:pointer;font-size:1.2rem;">
                        <span id="iconReceitas">üëÅÔ∏è</span>
                    </button>
                </div>
                </div>
            </div>

            <!-- Adicione aqui os componentes do dashboard -->
            <!-- Container de Categorias Top 10 -->
            <div class="container-tabela" style="margin-top: 2rem;">
                <div id="topCategoriesContainer">
                    <div class="top-categories-container">
                        <h4>Top 10 Categorias - Gastos</h4>
                        <!-- Div com overflow-x expl√≠cito e sem classes -->
                        <div class="tabela-rolavel" style="width: 100%; overflow-x: auto; white-space: nowrap; border: 1px solid #ddd; padding: 5px; border-radius: 4px; -webkit-overflow-scrolling: touch;">
                            <table class="primary" style="min-width: 600px; width: 100%;">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Categoria</th>
                                        <th>Valor</th>
                                        <th>% do Total</th>
                                    </tr>
                                </thead>
                            <tbody>
                                <!-- Skeleton Rows -->
                                <tr>
                                    <td><div style="width:1rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:6rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:3rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:4rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                </tr>
                                <!-- Repetir 9 vezes -->
                                <tr>
                                    <td><div style="width:1rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:6rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:3rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:4rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                </tr>
                                <tr>
                                    <td><div style="width:1rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:6rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:3rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:4rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                </tr>
                                <tr>
                                    <td><div style="width:1rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:6rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:3rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:4rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                </tr>
                                <tr>
                                    <td><div style="width:1rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:6rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:3rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:4rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                </tr>
                                <tr>
                                    <td><div style="width:1rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:6rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:3rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:4rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                </tr>
                                <tr>
                                    <td><div style="width:1rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:6rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:3rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:4rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                </tr>
                                <tr>
                                    <td><div style="width:1rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:6rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:3rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:4rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                </tr>
                                <tr>
                                    <td><div style="width:1rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:6rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:3rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                    <td><div style="width:4rem;height:1rem;background:#eee;border-radius:4px;animation:pulse 1.5s infinite;"></div></td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <style>
                        @keyframes pulse {
                            0% { opacity: 1; }
                            50% { opacity: 0.4; }
                            100% { opacity: 1; }
                        }
                        
                        /* Estilos para a tabela rol√°vel */
                        .tabela-rolavel {
                            width: 100%;
                            overflow-x: auto;
                            white-space: nowrap;
                            border: 1px solid #ddd;
                            padding: 5px;
                            border-radius: 4px;
                            -webkit-overflow-scrolling: touch; /* Rolagem suave em iOS */
                            scrollbar-width: thin; /* Firefox */
                            scrollbar-color: #ccc transparent; /* Firefox */
                        }
                        
                        /* Estilo da barra de rolagem para Chrome e Safari */
                        .tabela-rolavel::-webkit-scrollbar {
                            height: 8px;
                            background-color: #f5f5f5;
                        }
                        
                        .tabela-rolavel::-webkit-scrollbar-thumb {
                            background-color: #ccc;
                            border-radius: 4px;
                        }
                        
                        /* Indicador visual de rolagem em dispositivos m√≥veis */
                        @media (max-width: 768px) {
                            .tabela-rolavel {
                                position: relative;
                            }
                            
                            /* Indicador de rolagem √† direita */
                            .tabela-rolavel::after {
                                content: "‚Üí";
                                position: absolute;
                                right: 5px;
                                top: 50%;
                                transform: translateY(-50%);
                                color: #999;
                                animation: fadeInOut 1.5s infinite;
                                pointer-events: none;
                                background: rgba(255,255,255,0.7);
                                padding: 5px;
                            }
                            
                            @keyframes fadeInOut {
                                0%, 100% { opacity: 0.3; }
                                50% { opacity: 1; }
                            }
                        }
                    </style>
                </div>
            </div>            <div style="margin-top: 2rem;">
                <a href="configuracao.html" id="configBtn" class="button primary" style="display: none;">‚öôÔ∏è Configurar
                    Integra√ß√£o</a>
            </div>
        </div>
        <!-- Bot√£o de adicionar lan√ßamento (flutuante) -->
        <button id="openEntryModal" class="button" aria-label="Adicionar lan√ßamento">+</button>
    </section>

    <!-- Modal de lan√ßamento de despesas/receitas -->
    <div id="entryModal" style="display:none; position:fixed; top:60px; left:0; width:100%; height:calc(100% - 60px); background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
        <button id="closeEntryModal" aria-label="Fechar modal" style="position:absolute; top:10px; right:10px; background:transparent; border:none; color:inherit; font-size:1.5rem; cursor:pointer; z-index:1002;">√ó</button>
        <div class="modal-content solution-card" style="background:white; padding:1.5rem; border-radius:4px; max-width:600px; width:90%; position:relative; max-height:90vh; overflow:auto;">
    <section class="section" style="padding:2rem 0; margin:0;">
        <div class="container">
            <div class="row">
                <div class="col-md-8 col-lg-6 mx-auto">
                    <div class="solution-card">
                        <h3 style="margin-bottom: 1.5rem;">Lan√ßamento de Despesa/Receita</h3>
                        <form id="expenseForm">
                            <fieldset>
                                <!-- Data e Hora -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseDate">Data:</label>
                                    <input type="datetime-local" id="expenseDate" name="data" class="form-control" required>
                                </div>
                                <!-- Conta -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseAccount">Conta:</label>
                                    <input type="text" id="expenseAccount" name="conta" class="form-control" placeholder="Ex: Conta Corrente, Cart√£o de Cr√©dito" required>
                                </div>
                                <!-- Valor com toggle de sinal -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseValue">Valor:</label>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <button type="button" id="expenseSignBtn" class="button outline" aria-label="Alternar sinal" style="background-color: white; color: inherit; border: 1px solid #ccc; width: 2.5rem; text-align: center;">-</button>
                                        <input type="number" id="expenseValue" name="valor" class="form-control" step="0.01" min="0" placeholder="0,00" required>
                                        <input type="hidden" id="expenseSignValue" name="sinal" value="-">
                                    </div>
                                </div>
                                <!-- Descri√ß√£o -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseDescription">Descri√ß√£o:</label>
                                    <input type="text" id="expenseDescription" name="descricao" class="form-control" placeholder="Descri√ß√£o da despesa" required>
                                </div>
                                <!-- Categoria: combobox com filtro -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label for="expenseCategory">Categoria:</label>
                                    <input type="text" id="expenseCategory" name="categoria" class="form-control" placeholder="Selecione ou digite uma categoria" list="categoriaList" autocomplete="off" required>
                                    <datalist id="categoriaList"></datalist>
                                </div>
                                <!-- Or√ßamento -->
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label for="expenseBudget">Or√ßamento:</label>
                                    <select id="expenseBudget" name="orcamento" class="form-control" required></select>
                                </div>
                                <!-- Bot√µes -->

                                <div class="form-group" style="display:flex; justify-content:space-around; align-items:center; margin-top:2rem;">
                                    <button type="reset" class="button warning">Limpar</button>
                                    <button type="submit" class="button success">Salvar</button>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div> <!-- modal-content -->
</div> <!-- entryModal -->

    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Planilha Eh Tudo. Simplificando suas finan√ßas.</p>
        </div>
        <p>
            <small>Produzido por
                <a href="https://www.ehtudo.app">Eh!Tudo.app</a></small>
        </p>
    </footer>
    <!-- Script PocketBase e m√≥dulos da aplica√ß√£o -->
    <script type="module">
        // Hist√≥rico para autocomplete de descri√ß√µes
        let historicoLancamentos = [];
        // Controle de exibi√ß√£o dos valores dos cards de receita e despesa
        // Carregar prefer√™ncias de visibilidade do localStorage
        const storedDespesasVisible = localStorage.getItem('despesasVisivel');
        let despesasVisivel = storedDespesasVisible !== null ? JSON.parse(storedDespesasVisible) : true;
        const storedReceitasVisible = localStorage.getItem('receitasVisivel');
        let receitasVisivel = storedReceitasVisible !== null ? JSON.parse(storedReceitasVisible) : true;
        const despesasValueText = document.getElementById('despesasValueText');
        const receitasValueText = document.getElementById('receitasValueText');
        const iconDespesas = document.getElementById('iconDespesas');
        const iconReceitas = document.getElementById('iconReceitas');
        let valorDespesasAtual = despesasValueText ? despesasValueText.textContent.trim() : '';
        let valorReceitasAtual = receitasValueText ? receitasValueText.textContent.trim() : '';

        // Aplicar estado inicial de visibilidade
        if (!despesasVisivel && despesasValueText && iconDespesas) {
            valorDespesasAtual = despesasValueText.textContent;
            despesasValueText.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            iconDespesas.textContent = 'üôà';
        }
        if (!receitasVisivel && receitasValueText && iconReceitas) {
            valorReceitasAtual = receitasValueText.textContent;
            receitasValueText.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            iconReceitas.textContent = 'üôà';
        }

        if (document.getElementById('toggleDespesas')) {
            document.getElementById('toggleDespesas').addEventListener('click', () => {
                despesasVisivel = !despesasVisivel;
                if (despesasVisivel) {
                    despesasValueText.textContent = valorDespesasAtual;
                    iconDespesas.textContent = 'üëÅÔ∏è';
                } else {
                    valorDespesasAtual = despesasValueText.textContent;
                    despesasValueText.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    iconDespesas.textContent = 'üôà';
                }
                // Salvar prefer√™ncia
                localStorage.setItem('despesasVisivel', JSON.stringify(despesasVisivel));
            });
        }
        if (document.getElementById('toggleReceitas')) {
            document.getElementById('toggleReceitas').addEventListener('click', () => {
                receitasVisivel = !receitasVisivel;
                if (receitasVisivel) {
                    receitasValueText.textContent = valorReceitasAtual;
                    iconReceitas.textContent = 'üëÅÔ∏è';
                } else {
                    valorReceitasAtual = receitasValueText.textContent;
                    receitasValueText.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    iconReceitas.textContent = 'üôà';
                }
                // Salvar prefer√™ncia
                localStorage.setItem('receitasVisivel', JSON.stringify(receitasVisivel));
            });
        }
        import apiConfig from '../js/config/api-config.js';
        import { inicializarMenuUsuario } from '../js/menu-usuario.js';
        import googleSheetsService from '../js/google/sheets-api.js';
        import TopCategoriesChart from '../js/components/top-categories-chart.js';

        // Inicializa o PocketBase globalmente antes dos m√≥dulos
        window.pb = new PocketBase(apiConfig.getBaseURL());

        inicializarMenuUsuario();

        // Inicializa o servi√ßo Google Sheets
        googleSheetsService.init(window.pb);

        setTimeout(() => {
            import('../js/protecao-dashboard.js')
                .then(() => {
                    console.log('M√≥dulo de prote√ß√£o do dashboard carregado com sucesso.');
                })
                .catch(err => {
                    console.error('Erro ao carregar o m√≥dulo de prote√ß√£o do dashboard:', err);
                });
        }, 100); // Aguarda 100 milissegundos para garantir que a autentica√ß√£o seja verificada

        // Substitui verifica√ß√£o frontend por rota de configura√ß√£o no servidor
        (async () => {
            const configBtn = document.getElementById('configBtn');
            const financialCards = document.getElementById('financialCards');
            
            if (!configBtn) {
                console.log('Bot√£o de configura√ß√£o n√£o encontrado');
                return;
            }
            
            try {
                console.log('Verificando status de configura√ß√£o...');
                const response = await fetch(`${apiConfig.getBaseURL()}/config-status`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${pb.authStore.token}`
                    }
                });
                
                console.log('Status da resposta de configura√ß√£o:', response.status);
                
                if (!response.ok) {
                    throw new Error('Erro na requisi√ß√£o de configura√ß√£o');
                }
                
                const data = await response.json();
                console.log('Dados de configura√ß√£o:', data);
                
                // Exibe bot√£o se configura√ß√£o inv√°lida ou campos faltando
                if (!data.validConfig) {
                    console.log('Configura√ß√£o incompleta, campos faltando:', data.missing);
                    configBtn.style.display = '';
                } else {
                    console.log('Configura√ß√£o OK, carregando dados financeiros...');
                    // Se configura√ß√£o OK, carrega dados financeiros
                    await carregarDadosFinanceiros();
                    financialCards.style.display = 'grid';
                    
                    // Carregar per√≠odos dispon√≠veis
                    await carregarPeriodosDisponiveis();
                    
                    // Inicializa componente de categorias
                    const topCategoriesChart = new TopCategoriesChart('topCategoriesContainer', { limit: 10, periodo: 'atual' });
                    topCategoriesChart.init();
                    
                    // Armazenar refer√™ncia do componente no container para acesso posterior
                    const container = document.getElementById('topCategoriesContainer');
                    if (container) {
                        container._topCategoriesChart = topCategoriesChart;
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar configura√ß√£o do Google:', error);
                configBtn.style.display = '';
            }
        })();

        // Vari√°vel global para armazenar contas sugeridas
        let contasSugeridas = [];
        
        // Vari√°veis globais para controle de per√≠odo
        let periodosDisponiveis = [];
        let periodoAtualSelecionado = null;

        // Fun√ß√£o para carregar dados financeiros
        async function carregarDadosFinanceiros(budgetCode = null) {
             try {
                console.log('Carregando dados financeiros...');
                
                // Garantir que os cards est√£o vis√≠veis primeiro
                const financialCards = document.getElementById('financialCards');
                if (financialCards) {
                    financialCards.style.display = 'grid';
                    console.log('Cards for√ßados a ficar vis√≠veis');
                }
                
                // Aguardar um tempo para garantir que o DOM est√° pronto
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Construir URL com par√¢metro opcional
                let url = '/get-financial-summary';
                if (budgetCode) {
                    url += `?budget=${budgetCode}`;
                }
                
                const response = await fetch(`${apiConfig.getBaseURL()}${url}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${pb.authStore.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const summary = await response.json();
                
                // Armazena hist√≥rico e contas sugeridas
                historicoLancamentos = summary.historicoLancamentos || [];
                contasSugeridas = summary.contasSugeridas || [];
                initDescricaoAutocomplete();
                initContaAutocomplete();
                console.log('Resposta da API financeira:', summary);
                
                if (summary && summary.success) {
                    console.log('Dados v√°lidos recebidos, chamando atualizarCardsFinanceiros...');
                    atualizarCardsFinanceiros(summary);
                    
                    // Atualizar tamb√©m o componente de categorias
                    const topCategoriesContainer = document.getElementById('topCategoriesContainer');
                    if (topCategoriesContainer && topCategoriesContainer._topCategoriesChart) {
                        topCategoriesContainer._topCategoriesChart.updateData(summary.categorias || []);
                    }
                    
                    // Verificar se n√£o h√° dados para o per√≠odo
                    const temDados = summary.receitas > 0 || summary.despesas > 0 || (summary.categorias && summary.categorias.length > 0);
                    if (!temDados && budgetCode) {
                        const periodo = periodoAtualSelecionado ? periodoAtualSelecionado.displayName : 'per√≠odo selecionado';
                        mostrarMensagem('warning', `Nenhum lan√ßamento encontrado para ${periodo}.`);
                    }
                } else {
                    console.error('Erro ao carregar dados financeiros:', summary ? summary.error : 'Resposta inv√°lida');
                    removerLoadingCards();
                    if (budgetCode) {
                        mostrarMensagem('error', summary ? summary.error : 'Erro ao carregar dados do per√≠odo.');
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados financeiros:', error);
                // Em caso de erro, mant√©m os cards com valores zerados
                removerLoadingCards();
            }
        }

        // Fun√ß√£o para carregar per√≠odos dispon√≠veis
        async function carregarPeriodosDisponiveis() {
            try {
                const response = await fetch(`${apiConfig.getBaseURL()}/get-available-periods`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${pb.authStore.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    periodosDisponiveis = data.periods || [];
                    populateSelectors();
                } else {
                    console.warn('N√£o foi poss√≠vel carregar per√≠odos dispon√≠veis, usando padr√£o');
                    // Se n√£o conseguir carregar, cria per√≠odos padr√£o
                    criarPeriodosPadrao();
                }
            } catch (error) {
                console.error('Erro ao carregar per√≠odos:', error);
                // Em caso de erro, cria per√≠odos padr√£o
                criarPeriodosPadrao();
            }
        }

        // Fun√ß√£o para criar per√≠odos padr√£o quando n√£o conseguir carregar da API
        function criarPeriodosPadrao() {
            const meses = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
            const now = new Date();
            const atual = new Date(now.getFullYear(), now.getMonth(), 1);
            
            periodosDisponiveis = [];
            for (let i = -6; i <= 6; i++) {
                const d = new Date(atual.getFullYear(), atual.getMonth() + i, 1);
                const mesNome = meses[d.getMonth()];
                const anoCurto = String(d.getFullYear()).slice(-2);
                const nomeDisplay = `${mesNome.charAt(0).toUpperCase() + mesNome.slice(1)}/${anoCurto}`;
                
                // Calcular c√≥digo do or√ßamento (Excel serial date)
                const excelDate = Math.floor((d - new Date(1900, 0, 1)) / (1000 * 60 * 60 * 24)) + 2;
                
                periodosDisponiveis.push({
                    budgetCode: excelDate,
                    monthCode: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
                    displayName: nomeDisplay,
                    isCurrent: i === 0
                });
            }
            populateSelectors();
        }

        // Fun√ß√£o para popular os seletores
        function populateSelectors() {
            const budgetSelector = document.getElementById('budgetSelector');
            
            if (!budgetSelector) return;
            
            // Limpar op√ß√µes existentes
            budgetSelector.innerHTML = '';
            
            // Verificar se temos per√≠odos dispon√≠veis
            if (!periodosDisponiveis || periodosDisponiveis.length === 0) {
                // Adicionar op√ß√£o de erro
                budgetSelector.innerHTML = '<option value="">Nenhum per√≠odo dispon√≠vel</option>';
                return;
            }
            
            // Popular seletor
            periodosDisponiveis.forEach(period => {
                const budgetOption = document.createElement('option');
                budgetOption.value = period.budgetCode;
                budgetOption.textContent = period.displayName;
                if (period.isCurrent) {
                    budgetOption.selected = true;
                    periodoAtualSelecionado = period;
                }
                budgetSelector.appendChild(budgetOption);
            });
            
            // Mostrar seletor
            const periodSelectors = document.getElementById('periodSelectors');
            if (periodSelectors) {
                periodSelectors.style.display = 'block';
            }
        }

        // Fun√ß√£o para atualizar per√≠odo selecionado
        function atualizarPeriodoSelecionado() {
            const budgetSelector = document.getElementById('budgetSelector');
            
            if (!budgetSelector) return;
            
            const budgetCode = budgetSelector.value;
            
            // Verificar se o valor √© v√°lido
            if (!budgetCode) {
                mostrarMensagem('error', 'Por favor, selecione um per√≠odo v√°lido.');
                return;
            }
            
            // Encontrar per√≠odo correspondente
            const periodoEncontrado = periodosDisponiveis.find(p => 
                p.budgetCode == budgetCode
            );
            
            if (periodoEncontrado) {
                periodoAtualSelecionado = periodoEncontrado;
                console.log('Atualizando para per√≠odo:', periodoEncontrado);
                
                // Recarregar dados financeiros para o novo per√≠odo
                carregarDadosFinanceiros(budgetCode).then(() => {
                    // Atualizar componente de categorias
                    const topCategoriesContainer = document.getElementById('topCategoriesContainer');
                    if (topCategoriesContainer && topCategoriesContainer._topCategoriesChart) {
                        topCategoriesContainer._topCategoriesChart.updatePeriod(budgetCode);
                    }
                    
                    mostrarMensagem('success', `Dados atualizados para ${periodoEncontrado.displayName}`);
                }).catch(error => {
                    console.error('Erro ao carregar dados do per√≠odo:', error);
                    mostrarMensagem('error', 'Erro ao carregar dados do per√≠odo selecionado.');
                });
            } else {
                mostrarMensagem('error', 'Per√≠odo selecionado n√£o encontrado.');
            }
        }

        // Fun√ß√£o para atualizar os cards com os dados
        function atualizarCardsFinanceiros(data) {
            console.log('Dados recebidos para atualizar cards:', data);
            
            // Verificar se os elementos existem
            const saldoEl = document.getElementById('saldoValue');
            const despesasValueText = document.getElementById('despesasValueText');
            const receitasValueText = document.getElementById('receitasValueText');
            const despesasVariationEl = document.getElementById('despesasVariation');
            
            console.log('Elementos encontrados:', {
                saldo: saldoEl ? 'OK' : 'ERRO',
                despesas: despesasValueText ? 'OK' : 'ERRO',
                receitas: receitasValueText ? 'OK' : 'ERRO',
                despesasVariation: despesasVariationEl ? 'OK' : 'ERRO'
            });
            
            if (!saldoEl || !despesasValueText || !receitasValueText) {
                console.error('Alguns elementos n√£o foram encontrados no DOM');
                return;
            }
            
            // Formatador de moeda brasileira
            const formatarMoeda = (valor) => {
                console.log('Formatando valor:', valor, 'tipo:', typeof valor);
                const resultado = new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(valor);
                console.log('Valor formatado:', resultado);
                return resultado;
            };

            // Formatador de varia√ß√£o percentual (apenas para despesas)
            const formatarVariacaoDespesas = (variacao) => {
                console.log('Formatando varia√ß√£o de despesas:', variacao);
                const sinal = variacao >= 0 ? '+' : '';
                // Para despesas: varia√ß√£o negativa √© boa (menos gastos = üìâ verde), positiva √© ruim (mais gastos = üìà vermelho)
                const icone = variacao > 0 ? 'üìà' : variacao < 0 ? 'üìâ' : 'üìä';
                const classe = variacao > 0 ? 'variation-negative' : 
                             variacao < 0 ? 'variation-positive' : 'variation-neutral';
                
                return {
                    texto: `${sinal}${variacao.toFixed(1)}% em rela√ß√£o ao m√™s anterior`,
                    classe: classe,
                    icone: icone
                };
            };

            // Atualizar Saldo (sem varia√ß√£o)
            const saldoFormatado = formatarMoeda(data.saldo || 0);
            console.log('Atualizando saldo com:', saldoFormatado);
            saldoEl.textContent = saldoFormatado;

            // Atualizar Despesas (com varia√ß√£o) e preservar visibilidade
            const despesasFormatado = formatarMoeda(data.despesas || 0);
            console.log('Atualizando despesas com:', despesasFormatado);
            // Atualiza valor armazenado
            valorDespesasAtual = despesasFormatado;
            // Aplica visibilidade conforme prefer√™ncia
            if (despesasVisivel) {
                despesasValueText.textContent = valorDespesasAtual;
            } else {
                despesasValueText.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }

            if (despesasVariationEl && typeof data.variacaoDespesas === 'number') {
                const despesasVar = formatarVariacaoDespesas(data.variacaoDespesas);
                despesasVariationEl.className = `card-variation ${despesasVar.classe}`;
                despesasVariationEl.innerHTML = `
                    <span class="variation-icon">${despesasVar.icone}</span>
                    <span>${despesasVar.texto}</span>
                `;
                console.log('Varia√ß√£o de despesas atualizada:', despesasVar);
            }

            // Atualizar Receitas (sem varia√ß√£o) e preservar visibilidade
            const receitasFormatado = formatarMoeda(data.receitas || 0);
            console.log('Atualizando receitas com:', receitasFormatado);
            // Atualiza valor armazenado
            valorReceitasAtual = receitasFormatado;
            // Aplica visibilidade conforme prefer√™ncia
            if (receitasVisivel) {
                receitasValueText.textContent = valorReceitasAtual;
            } else {
                receitasValueText.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }

            // Remover estado de loading
            removerLoadingCards();
            
            console.log('Cards financeiros atualizados com sucesso');
            
            // Verificar se os valores foram realmente aplicados
            setTimeout(() => {
                console.log('Verifica√ß√£o ap√≥s atualiza√ß√£o:');
                console.log('Saldo DOM:', saldoEl.textContent);
                console.log('Despesas DOM:', despesasEl.textContent);
                console.log('Receitas DOM:', receitasEl.textContent);
            }, 100);
        }

        // Fun√ß√£o para remover estado de loading dos cards
        function removerLoadingCards() {
            console.log('Removendo estado de loading dos cards...');
            document.querySelectorAll('.financial-card.loading').forEach(card => {
                console.log('Removendo loading do card:', card.className);
                card.classList.remove('loading');
            });
        }

        // Fun√ß√£o de teste para verificar se conseguimos atualizar os cards
        function testarAtualizacaoCards() {
            console.log('Testando atualiza√ß√£o manual dos cards...');
            const dadosTeste = {
                saldo: 1000,
                despesas: 500,
                receitas: 1500,
                variacaoDespesas: 10
            };
            atualizarCardsFinanceiros(dadosTeste);
        }

        // Fun√ß√£o para testar DOM diretamente
        function testeDomsimples() {
            console.log('=== TESTE DOM SIMPLES ===');
            
            setTimeout(() => {
                const saldoEl = document.getElementById('saldoValue');
                const despesasEl = document.getElementById('despesasValue');
                const receitasEl = document.getElementById('receitasValue');
                
                console.log('Saldo elemento:', saldoEl);
                console.log('Despesas elemento:', despesasEl);
                console.log('Receitas elemento:', receitasEl);
                
                if (saldoEl) {
                    saldoEl.textContent = 'R$ 1.000,00';
                    console.log('Saldo atualizado para R$ 1.000,00');
                } else {
                    console.error('Elemento saldoValue n√£o encontrado!');
                }
                if (despesasEl) {
                    despesasEl.textContent = 'R$ 500,00';
                    console.log('Despesas atualizadas para R$ 500,00');
                } else {
                    console.error('Elemento despesasValue n√£o encontrado!');
                }
                if (receitasEl) {
                    receitasEl.textContent = 'R$ 1.500,00';
                    console.log('Receitas atualizadas para R$ 1.500,00');
                } else {
                    console.error('Elemento receitasValue n√£o encontrado!');
                }
                
                // Verificar se mudou
                setTimeout(() => {
                    console.log('Verifica√ß√£o final:');
                    console.log('Saldo atual:', saldoEl ? saldoEl.textContent : 'elemento n√£o encontrado');
                    console.log('Despesas atual:', despesasEl ? despesasEl.textContent : 'elemento n√£o encontrado');
                    console.log('Receitas atual:', receitasEl ? receitasEl.textContent : 'elemento n√£o encontrado');
                }, 1000);
                
            }, 2000);
        }

        // Disponibilizar fun√ß√£o de teste globalmente para debug
        //window.testarCards = testarAtualizacaoCards;
        //window.testeDomsimples = testeDomsimples;
        
        // Executar teste autom√°tico
        //setTimeout(testeDomsimples, 3000);

        // Controle de sinal de valor
        const expenseSignBtn = document.getElementById('expenseSignBtn');
        const expenseSignValue = document.getElementById('expenseSignValue');
        let currentSign = '-';
        function updateSign() {
            expenseSignBtn.textContent = currentSign;
            expenseSignBtn.style.color = currentSign === '+' ? 'green' : 'red';
            expenseSignValue.value = currentSign;
        }
        expenseSignBtn.addEventListener('click', () => {
            currentSign = currentSign === '+' ? '-' : '+';
            updateSign();
        });
        updateSign();
        
        // Script especial para garantir rolagem nas tabelas
        document.addEventListener('DOMContentLoaded', function() {
            // For√ßar rolagem em todas as tabelas responsivas
            const tables = document.querySelectorAll('.table-responsive');
            tables.forEach(function(table) {
                // Garante que a tabela interna seja larga o suficiente
                const innerTable = table.querySelector('table');
                if (innerTable) {
                    innerTable.style.minWidth = '600px';
                }
                
                // For√ßa overflow-x: scroll (alguns navegadores mobile ignoram)
                table.style.overflowX = 'scroll';
                table.style.display = 'block';
                
                // Adiciona bordas para tornar vis√≠vel
                table.style.border = '1px solid #ddd';
                table.style.borderRadius = '4px';
                table.style.padding = '8px 0';
                
                // Ajusta a altura da scrollbar para ser mais vis√≠vel
                table.style.paddingBottom = '15px';
            });
        });

        // Define valores iniciais dos inputs de data e or√ßamento
        const expenseDateInput = document.getElementById('expenseDate');
        // Define data e hora atuais no hor√°rio local
        {
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const localDate = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
            const localTime = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
            expenseDateInput.value = `${localDate}T${localTime}`;
        }
        const expenseBudgetSelect = document.getElementById('expenseBudget');
        if (expenseBudgetSelect) {
            // Meses em portugu√™s
            const meses = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
            const now = new Date();
            const atual = new Date(now.getFullYear(), now.getMonth(), 1);
            for (let i = -6; i <= 6; i++) {
                const d = new Date(atual.getFullYear(), atual.getMonth() + i, 1);
                const mesNome = meses[d.getMonth()];
                const anoCurto = String(d.getFullYear()).slice(-2);
                const valor = `${mesNome}/${anoCurto}`;
                const opt = document.createElement('option');
                opt.value = valor;
                opt.textContent = valor.charAt(0).toUpperCase() + valor.slice(1);
                if (i === 0) opt.selected = true;
                expenseBudgetSelect.appendChild(opt);
            }
        }


        // Carrega categorias diretamente da planilha (aba 'Categorias')
        async function carregarCategorias() {
            const categoryInput = document.getElementById('expenseCategory');
            const dataList = document.getElementById('categoriaList');
            if (!categoryInput || !dataList) return;
            
            try {
                // Tenta buscar categorias da planilha
                const categorias = await googleSheetsService.getCategories();
                
                // Limpa op√ß√µes existentes do datalist
                dataList.innerHTML = '';
                const lista = (categorias && categorias.length) ? categorias : [
                    'Alimenta√ß√£o', 'Transporte', 'Moradia', 'Sa√∫de',
                    'Educa√ß√£o', 'Lazer', 'Vestu√°rio', 'Outras'
                ];
                lista.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    dataList.appendChild(opt);
                });
                console.log('Categorias dispon√≠veis:', lista);
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                // Em caso de erro, usa categorias padr√£o no datalist
                dataList.innerHTML = '';
                ['Alimenta√ß√£o', 'Transporte', 'Moradia', 'Sa√∫de',
                 'Educa√ß√£o', 'Lazer', 'Vestu√°rio', 'Outras']
                 .forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat;
                    dataList.appendChild(opt);
                });
            }
        }
        
        // Carrega as categorias ao iniciar a p√°gina
        carregarCategorias();


        // --- ENVIO DO FORMUL√ÅRIO PARA APENDAR NA PLANILHA DO GOOGLE ---
        const expenseForm = document.getElementById('expenseForm');
        if (expenseForm) {
            expenseForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.textContent;
                submitBtn.textContent = 'Enviando...';
                submitBtn.disabled = true;
                try {
                    // Coleta e prepara os dados do formul√°rio
                    const data = formatarData(document.getElementById('expenseDate').value);
                    const conta = document.getElementById('expenseAccount').value.trim();
                    const valorBase = parseFloat(document.getElementById('expenseValue').value);
                    const sinal = document.getElementById('expenseSignValue').value;
                    const valor = sinal === '-' ? -Math.abs(valorBase) : Math.abs(valorBase);
                    const descricao = document.getElementById('expenseDescription').value.trim();
                    const categoria = document.getElementById('expenseCategory').value.trim();
                    const orcamento = formatarDataOrcamento(document.getElementById('expenseBudget').value);

                    const entryData = {
                        data,
                        conta,
                        valor: valor.toFixed(2).replace('.', ','),
                        descricao,
                        categoria,
                        orcamento
                    };

                    // Chama o servi√ßo para apendar na planilha
                    const resultado = await googleSheetsService.addEntry(entryData);

                    if (resultado.success) {
                        mostrarMensagem('success', 'Lan√ßamento enviado com sucesso!');
                        limparCamposFormulario();
                        // Atualiza os cards do resumo ap√≥s novo lan√ßamento
                        await carregarDadosFinanceiros();
                        // Fecha o modal automaticamente ap√≥s sucesso
                        setTimeout(() => {
                            closeModal();
                        }, 1000); // Aguarda 1 segundo para mostrar a mensagem
                    } else {
                        throw new Error(resultado.error || 'Erro ao enviar lan√ßamento');
                    }
                } catch (error) {
                    console.error('Erro ao enviar dados:', error);
                    mostrarMensagem('error', 'Erro ao enviar lan√ßamento: ' + (error.message || error));
                } finally {
                    submitBtn.textContent = originalBtnText;
                    submitBtn.disabled = false;
                }
            });
        }

        // Fun√ß√µes auxiliares
        function formatarData(dataHora) {
            // Converte 2025-08-01T14:30 para 01/08/2025 14:30
            const dt = new Date(dataHora);
            const dia = String(dt.getDate()).padStart(2, '0');
            const mes = String(dt.getMonth() + 1).padStart(2, '0');
            const ano = dt.getFullYear();
            const hora = String(dt.getHours()).padStart(2, '0');
            const minuto = String(dt.getMinutes()).padStart(2, '0');
            return `${dia}/${mes}/${ano} ${hora}:${minuto}`;
        }
        function formatarDataOrcamento(data) {
            // Converte "setembro/25" para "01/09/2025"
            if (!data) return '';
            const meses = ['janeiro','fevereiro','mar√ßo','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
            const [mesNome, anoCurto] = data.split('/');
            const mesIndex = meses.indexOf(mesNome.toLowerCase());
            if (mesIndex === -1) return '';
            const ano = '20' + anoCurto;
            const mes = String(mesIndex + 1).padStart(2, '0');
            return `01/${mes}/${ano}`;
        }
        function limparCamposFormulario() {
            document.getElementById('expenseAccount').value = '';
            document.getElementById('expenseValue').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseCategory').value = '';
            currentSign = '-';
            updateSign();
        }
        function mostrarMensagem(tipo, texto) {
            let msgEl = document.getElementById('feedback-message');
            if (!msgEl) {
                msgEl = document.createElement('div');
                msgEl.id = 'feedback-message';
                msgEl.style.position = 'fixed';
                msgEl.style.top = '70px';
                msgEl.style.right = '20px';
                msgEl.style.padding = '15px 20px';
                msgEl.style.borderRadius = '4px';
                msgEl.style.fontSize = '16px';
                msgEl.style.fontWeight = 'bold';
                msgEl.style.zIndex = '10000';
                msgEl.style.maxWidth = '300px';
                msgEl.style.wordWrap = 'break-word';
                document.body.appendChild(msgEl);
            }
            if (tipo === 'success') {
                msgEl.style.backgroundColor = '#4CAF50';
                msgEl.style.color = 'white';
            } else if (tipo === 'warning') {
                msgEl.style.backgroundColor = '#ff9800';
                msgEl.style.color = 'white';
            } else {
                msgEl.style.backgroundColor = '#F44336';
                msgEl.style.color = 'white';
            }
            msgEl.textContent = texto;
            msgEl.style.display = 'block';
            
            // Auto-hide ap√≥s tempo baseado no tipo
            const hideTime = tipo === 'warning' ? 7000 : 5000;
            setTimeout(() => {
                msgEl.style.display = 'none';
            }, hideTime);
        }

        // Remove aviso de formul√°rio desabilitado
        const aviso = document.querySelector('.solution-card > p');
        if (aviso) aviso.style.display = 'none';

        // Inicializa autocomplete para o campo de descri√ß√£o
        function initDescricaoAutocomplete() {
            const input = document.getElementById('expenseDescription');
            if (!input) return;
            // Ajusta container pai para posicionamento
            input.parentNode.style.position = 'relative';
            let suggestions = document.getElementById('descricaoSuggestions');
            if (!suggestions) {
                suggestions = document.createElement('div');
                suggestions.id = 'descricaoSuggestions';
                Object.assign(suggestions.style, {
                    position: 'absolute',
                    top: '100%', // posiciona logo abaixo do input
                    left: '0',
                    right: '0',
                    background: 'white',
                    border: 'none', // sem borda ap√≥s sele√ß√£o
                    maxHeight: '150px',
                    overflowY: 'auto',
                    zIndex: '1000'
                });
                input.parentNode.appendChild(suggestions);
                // Oculta sugest√µes inicialmente
                suggestions.style.display = 'none';
            }
            input.addEventListener('input', onDescricaoInput);
            // Fecha sugest√µes ao clicar fora
            document.addEventListener('click', (e) => {
                if (e.target !== input && !suggestions.contains(e.target)) {
                    suggestions.innerHTML = '';
                    suggestions.style.display = 'none';
                    suggestions.style.border = 'none';
                }
            });
        }

        // Gera sugest√µes conforme digita√ß√£o
        function onDescricaoInput(e) {
            const val = e.target.value.trim().toLowerCase();
            const container = document.getElementById('descricaoSuggestions');
            // Limpa e esconde container antes de processar
            container.innerHTML = '';
            if (val.length < 3) {
                container.style.display = 'none';
                return;
            }
            const matches = historicoLancamentos.filter(item => item.descricao.toLowerCase().includes(val));
            if (matches.length === 0) {
                container.style.display = 'none';
                return;
            }
            // Exibe container de sugest√µes
            container.style.display = 'block';
            container.style.border = '1px solid #ccc';
            matches.slice(0, 5).forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = item.descricao;
                div.style.padding = '0.5rem';
                div.style.cursor = 'pointer';
                div.addEventListener('click', () => {
                    // Preenche descri√ß√£o e categoria
                    document.getElementById('expenseDescription').value = item.descricao;
                    const categoryInput = document.getElementById('expenseCategory');
                    // Define o valor da categoria no input diretamente
                    categoryInput.value = item.categoria;
                    // Limpa e esconde o container de sugest√µes
                    container.innerHTML = '';
                    container.style.display = 'none';
                });
                container.appendChild(div);
            });
        }

        // Autocomplete para contas
        function initContaAutocomplete() {
            const input = document.getElementById('expenseAccount');
            if (!input) return;
            input.parentNode.style.position = 'relative';
            let suggestions = document.getElementById('contaSuggestions');
            if (!suggestions) {
                suggestions = document.createElement('div');
                suggestions.id = 'contaSuggestions';
                Object.assign(suggestions.style, {
                    position: 'absolute',
                    top: '100%', // posiciona abaixo do input
                    left: '0', right: '0',
                    background: 'white', border: 'none', // sem borda ap√≥s sele√ß√£o
                    maxHeight: '150px', overflowY: 'auto', zIndex: '1000', display: 'none'
                });
                input.parentNode.appendChild(suggestions);
            }
            input.addEventListener('input', () => {
                const val = input.value.trim().toLowerCase();
                const container = document.getElementById('contaSuggestions');
                container.innerHTML = '';
                if (!val) {
                  contasSugeridas.slice(0,5).forEach(c => {
                    const div = document.createElement('div'); div.textContent = c; div.style.padding = '0.5rem'; div.style.cursor='pointer';
                    div.addEventListener('click', ()=>{ input.value = c; container.innerHTML = ''; });
                    container.appendChild(div);
                  });
                  container.style.display = 'block';
                  container.style.border = '1px solid #ccc';
                  return;
                }
                const matches = contasSugeridas.filter(c=> c.toLowerCase().includes(val));
                if (matches.length) {
                  matches.slice(0,5).forEach(c => {
                    const div = document.createElement('div'); div.textContent = c; div.style.padding = '0.5rem'; div.style.cursor='pointer';
                    div.addEventListener('click', ()=>{ input.value = c; container.innerHTML = ''; container.style.display = 'none'; });
                    container.appendChild(div);
                  });
                  container.style.display = 'block';
                  container.style.border = '1px solid #ccc';
                } else container.style.display = 'none';
            });
            document.addEventListener('click', e => {
                if (e.target !== input && !suggestions.contains(e.target)) {
                    suggestions.innerHTML = '';
                    suggestions.style.display = 'none';
                    suggestions.style.border = 'none';
                }
            });
        }

        // Fechar modal ao clicar fora do conte√∫do
        const entryModalEl = document.getElementById('entryModal');
        const openModalBtn = document.getElementById('openEntryModal');
        const closeModalBtn = document.getElementById('closeEntryModal');
        
        entryModalEl.addEventListener('click', e => {
            if (e.target === entryModalEl) {
                closeModal();
            }
        });
        
        // Fun√ß√£o para abrir modal e alterar bot√£o
        function openModal() {
            entryModalEl.style.display = 'flex';
            openModalBtn.classList.add('modal-open');
            openModalBtn.textContent = '√ó';
            openModalBtn.setAttribute('aria-label', 'Fechar modal');
        }
        
        // Fun√ß√£o para fechar modal e alterar bot√£o
        function closeModal() {
            entryModalEl.style.display = 'none';
            openModalBtn.classList.remove('modal-open');
            openModalBtn.textContent = '+';
            openModalBtn.setAttribute('aria-label', 'Adicionar lan√ßamento');
        }
        
        // Bot√µes de abrir e fechar modal
        openModalBtn.addEventListener('click', () => {
            if (entryModalEl.style.display === 'flex') {
                closeModal();
            } else {
                openModal();
            }
        });
        
        closeModalBtn.addEventListener('click', () => {
            closeModal();
        });
        
        // Fechar modal com tecla ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && entryModalEl.style.display === 'flex') {
                closeModal();
            }
        });

        // Script para garantir rolagem horizontal nas tabelas
        document.addEventListener('DOMContentLoaded', function() {
            // For√ßar rolagem em todas as tabelas responsivas
            function verificarTabelasRolaveis() {
                const tables = document.querySelectorAll('.tabela-rolavel');
                tables.forEach(function(table) {
                    // For√ßa overflow-x: auto
                    table.style.overflowX = 'auto';
                    
                    // Verifica se a tabela precisa de rolagem
                    if (table.scrollWidth > table.clientWidth) {
                        // Adiciona indicador visual se necess√°rio
                        if (!table.querySelector('.scroll-indicator')) {
                            const indicator = document.createElement('div');
                            indicator.className = 'scroll-indicator';
                            indicator.style.position = 'absolute';
                            indicator.style.right = '10px';
                            indicator.style.top = '50%';
                            indicator.style.transform = 'translateY(-50%)';
                            indicator.style.color = '#999';
                            indicator.style.backgroundColor = 'rgba(255,255,255,0.7)';
                            indicator.style.padding = '5px';
                            indicator.style.borderRadius = '3px';
                            indicator.style.pointerEvents = 'none';
                            indicator.textContent = '‚Üí';
                            indicator.style.animation = 'fadeInOut 1.5s infinite';
                            
                            // Posicionamento relativo para o indicador
                            table.style.position = 'relative';
                            table.appendChild(indicator);
                        }
                    }
                });
            }
            
            // Verifica imediatamente
            verificarTabelasRolaveis();
            
            // Verifica novamente ap√≥s o carregamento completo
            setTimeout(verificarTabelasRolaveis, 1000);
            
            // Adiciona estilo para anima√ß√£o do indicador
            if (!document.getElementById('fadeInOut-style')) {
                const style = document.createElement('style');
                style.id = 'fadeInOut-style';
                style.textContent = `
                    @keyframes fadeInOut {
                        0%, 100% { opacity: 0.3; }
                        50% { opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
        });
        
        // Event listeners para o seletor de per√≠odo
        document.addEventListener('DOMContentLoaded', function() {
            // Atualiza√ß√£o autom√°tica quando o seletor de or√ßamento mudar
            const budgetSelector = document.getElementById('budgetSelector');
            
            if (budgetSelector) {
                budgetSelector.addEventListener('change', function() {
                    if (this.value) {
                        atualizarPeriodoSelecionado();
                    }
                });
            }
        });
    </script>
</body>

</html>
