<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Google OAuth</title>
    <link rel="stylesheet" href="https://picnicss.com/picnic.min.css">
    <script src="/js/pocketbase/dist/pocketbase.umd.js"></script>
    <script src="/js/config/api-config.js"></script>
</head>

<body>
    <main class="container">
        <h1>Teste de Autorização Google Sheets</h1>

        <div id="oauth-section">
            <h2>Passo 1: Autorizar com Google</h2>
            <p>Configure as variáveis de ambiente antes de testar:</p>
            <ul>
                <li><code>GOOGLE_CLIENT_ID</code> - Seu Client ID do Google</li>
                <li><code>GOOGLE_CLIENT_SECRET</code> - Seu Client Secret do Google</li>
                <li><code>GOOGLE_REDIRECT_URI</code> - URL de callback (ex: http://localhost:8090/google-oauth-callback)
                </li>
            </ul>

            <button onclick="handleStartOAuth()" class="button">Iniciar Autorização Google</button>
        </div>

        <div id="result-section" style="display: none;">
            <h2>Resultado</h2>
            <pre id="result"></pre>
        </div>

        <div id="refresh-section" style="display: none;">
            <h2>Renovar Token</h2>
            <button onclick="handleRefreshToken()" class="button secondary">Renovar Access Token</button>
        </div>
    </main>

    <script type="module">
        import googleOAuthService from './js/google/oauth-service.js';

        // Inicializar o PocketBase globalmente
        const pb = new PocketBase(apiConfig.getBaseURL());
        
        // Inicializar o serviço OAuth
        googleOAuthService.init(pb);

        // Funções globais para os botões
        window.handleStartOAuth = async function() {
            try {
                await googleOAuthService.startOAuthFlow();
            } catch (error) {
                console.error(error);
                alert('Erro ao iniciar OAuth: ' + error.message);
            }
        };

        window.handleRefreshToken = async function() {
            const userId = pb.authStore.model?.id;
            if (!userId) {
                alert('Por favor, faça login primeiro');
                return;
            }

            try {
                const result = await googleOAuthService.refreshAccessToken(userId);
                document.getElementById('result').textContent = JSON.stringify(result, null, 2);
                document.getElementById('result-section').style.display = 'block';
            } catch (error) {
                document.getElementById('result').textContent = 'Erro: ' + error.message;
                document.getElementById('result-section').style.display = 'block';
            }
        };

        // Se a página foi carregada com parâmetros de sucesso ou erro, mostrar o resultado
        window.addEventListener('load', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const error = urlParams.get('error');

            if (success || error) {
                const result = success ? 'OAuth concluído com sucesso!' : 'Erro: ' + error;
                document.getElementById('result').textContent = result;
                document.getElementById('result-section').style.display = 'block';
                document.getElementById('refresh-section').style.display = 'block';
            }
        });
    </script>
</body>

</html>