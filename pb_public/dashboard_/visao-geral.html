<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Visão Geral - Seu App Financeiro</title>
    <link rel="stylesheet" href="../css/picnic.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/responsive-tables.css">
    <script src="../js/pocketbase/dist/pocketbase.umd.js"></script>
    <style>
        body { max-width: 100vw; overflow-x: hidden; }

        .account-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
        }

        .account-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
        .account-name { font-weight:700; margin:0; }
        .account-balance { font-size:1.25rem; font-weight:700; text-align:right; }
        .balance-positive { color: var(--success-color, #2ecc40); }
        .balance-negative { color: var(--alert-color, #ff4136); }
        .balance-zero { color: #777; }
        
        /* Estilos adicionais para correção de exibição de saldos */
        .balance { font-size:1.25rem; font-weight:700; text-align:right; }
        span.account-balance { display: inline-block; margin-left: auto; }

        .card-section { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; margin-top:16px; }
        @media (max-width:600px){ .card-section { grid-template-columns: 1fr; } }

        .budget-selector-card { background:white; border-radius:8px; padding:18px; box-shadow: 0 2px 4px rgba(0,0,0,0.06); max-width:480px; }
        .summary-card { background:linear-gradient(90deg,#4568dc,#b06ab3); color:#fff; border-radius:8px; padding:18px; margin-top:12px; }
        .summary-value { font-size:1.6rem; font-weight:700; }

        .loading-card { display:flex; align-items:center; justify-content:center; padding:2rem; color:#666; }

        .financial-card {
            background-color: var(--white-color, #fff);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.06);
            /* borda azul à esquerda para combinar com o dashboard */
            border-left: 4px solid #4568dc;
            display:flex;
            flex-direction:column;
        }
        .card-header { display:flex; align-items:center; gap:0.75rem; }
        .card-icon { font-size:1.6rem; }
        .card-title { font-size:1rem; margin:0; font-weight:700; color:var(--secondary-color,#333); }
        .card-value { margin-top:0.5rem; font-size:1.25rem; font-weight:700; display:flex; align-items:center; justify-content:space-between; }
        .account-budget-select { min-width:140px; }

        /* Estilos adicionais necessários */
        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #4568dc;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message-container {
            margin-bottom: 20px;
        }

        .message {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .fade-out {
            opacity: 0;
            transition: opacity 0.5s;
        }

        .dashboard-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-select {
            min-width: 150px;
        }

        .summary-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .summary-item {
            flex: 1 1 200px;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .summary-label {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <!-- NAV: menu dinâmico igual ao index.html -->
    <nav>
        <a href="/" class="brand"><span>Planilha Eh Tudo</span></a>
        <input id="bmenub" type="checkbox" class="show">
        <label for="bmenub" class="burger pseudo button">menu</label>
        <div class="menu" id="menu-user">
            <a href="#" class="pseudo button icon-picture">Demo</a>
            <a href="../login.html" class="button icon-puzzle" id="loginBtn">Login</a>
            <a href="../registro.html" class="button icon-user" id="registerBtn">Registrar</a>
        </div>
    </nav>

    <div class="app-container">
        <aside class="sidebar-menu">
            <a href="index.html" title="Dashboard">
                <span class="menu-icon">🏠</span>
                <span class="menu-text">Dashboard</span>
            </a>
            <a href="lancamentos.html" title="Lançamentos">
                <span class="menu-icon">📋</span>
                <span class="menu-text">Lançamentos</span>
            </a>
            <a href="visao-geral.html" class="active" title="Visão Geral">
                <span class="menu-icon">📊</span>
                <span class="menu-text">Visão Geral</span>
            </a>
        </aside>

        <main class="main-content">
            <section class="section section-light dashboard-main">
                <div class="container">
                    <h2>Visão Geral</h2>
                    <p>Visualize o saldo das contas para o orçamento selecionado.</p>

                    <div class="dashboard-controls">
                        <div class="filter-group">
                            <label for="orcamentoSelect">Orçamento:</label>
                            <select id="orcamentoSelect" class="filter-select"></select>
                        </div>
                        <button id="refreshAccountsBtn" class="button">
                            🔄 Atualizar
                        </button>
                    </div>

                    <!-- Indicador de carregamento -->
                    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p>Carregando contas...</p>
                    </div>

                    <div id="messageContainer" class="message-container"></div>

                    <!-- Resumo do período selecionado -->
                    <div class="summary-bar">
                        <div class="summary-item">
                            <div class="summary-label">Período</div>
                            <div class="summary-value" id="summaryPeriod"></div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Saldo Total</div>
                            <div class="summary-value" id="totalBalanceValue">R$ 0,00</div>
                        </div>
                    </div>

                    <div id="accountsContainer" class="card-section" style="margin-top:18px;">
                        <div class="loading-card"><div><p>Carregando dados...</p></div></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Planilha Eh Tudo. Simplificando suas finanças.</p>
        </div>
        <p><small>Produzido por <a href="https://www.ehtudo.app">Eh!Tudo.app</a></small></p>
    </footer>

    <script type="module">
        import apiConfig from '../js/config/api-config.js';
        import { estaAutenticado } from '../js/auth-service.js';
        import { exibirMenuUsuario } from '../js/menu-usuario.js';
        import googleSheetsService from '../js/google/sheets-api.js';
        import contasManager from '../js/contas-manager.js';

        window.pb = new PocketBase(apiConfig.getBaseURL());

        // budgets disponíveis e orçamento atual selecionado
        let availableBudgets = [];
        let currentBudget = null;

        // Inicialização principal
        if (!estaAutenticado()) {
            window.location.href = '../login.html';
        } else {
            exibirMenuUsuario();
            googleSheetsService.init(window.pb);

            // Carrega módulos de proteção e inicializa a página
            Promise.all([ import('../js/protecao-dashboard.js') ])
                .then(() => inicializarPagina())
                .catch(err => {
                    console.error('Erro ao carregar módulos do dashboard:', err);
                    inicializarPagina();
                });
        }

        async function inicializarPagina() {
            try {
                await carregarOrcamentos();

                // Adiciona listener para o botão de atualização
                const refreshBtn = document.getElementById('refreshAccountsBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        if (currentBudget) {
                            contasManager.carregarContas(currentBudget);
                        }
                    });
                }

                // inicia carregamento com o orçamento selecionado automaticamente
                if (currentBudget) {
                    // Inicializa o gerenciador de contas com o orçamento atual
                    await contasManager.init(currentBudget);
                    
                    // Atualiza o período no resumo
                    const periodEl = document.getElementById('summaryPeriod');
                    if (periodEl) {
                        periodEl.textContent = currentBudget.charAt(0).toUpperCase() + currentBudget.slice(1);
                    }
                }
            } catch (err) {
                console.error('Erro ao inicializar página:', err);
                mostrarMensagem('error', 'Erro ao inicializar página: ' + (err.message || err));
            }
        }

        async function carregarOrcamentos() {
            try {
                mostrarMensagem('info', 'Carregando orçamentos...');
                
                // Usar o ContasManager para carregar orçamentos para sincronizar
                await contasManager.carregarOrcamentosDisponiveis();
                let budgets = contasManager.getAvailableBudgets();
                
                // Verifica se precisa de fallback
                if (!budgets || budgets.length === 0) {
                    // fallback local similar ao restante do código-base
                    const meses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
                    const now = new Date();
                    for (let i=-6;i<=3;i++){
                        const d = new Date(now.getFullYear(), now.getMonth()+i,1);
                        budgets.push(`${meses[d.getMonth()]}/${String(d.getFullYear()).slice(-2)}`);
                    }
                }

                // armazena budgets globalmente e define orçamento corrente
                availableBudgets = budgets || [];
                if (!availableBudgets || availableBudgets.length === 0) {
                    mostrarMensagem('error', 'Nenhum orçamento disponível');
                    return;
                }

                // seleciona o orçamento atual como padrão ou o primeiro disponível
                const atual = obterOrcamentoAtual();
                currentBudget = availableBudgets.includes(atual) ? atual : availableBudgets[0];

                // Popula o select de orçamentos
                const orcamentoSelect = document.getElementById('orcamentoSelect');
                if (orcamentoSelect) {
                    orcamentoSelect.innerHTML = '';
                    availableBudgets.forEach(budget => {
                        const option = document.createElement('option');
                        option.value = budget;
                        option.textContent = budget.charAt(0).toUpperCase() + budget.slice(1);
                        if (budget === currentBudget) {
                            option.selected = true;
                        }
                        orcamentoSelect.appendChild(option);
                    });

                    // Adiciona listener para mudança de orçamento
                    orcamentoSelect.addEventListener('change', (e) => {
                        currentBudget = e.target.value;
                        contasManager.carregarContas(currentBudget);
                        
                        // Atualiza o período no resumo
                        const periodEl = document.getElementById('summaryPeriod');
                        if (periodEl) {
                            periodEl.textContent = currentBudget.charAt(0).toUpperCase() + currentBudget.slice(1);
                        }
                    });
                }
                currentBudget = availableBudgets.includes(atual) ? atual : availableBudgets[0];

                limparMensagens();
            } catch (err) {
                console.error('Erro ao carregar orçamentos:', err);
                mostrarMensagem('error', 'Erro ao carregar orçamentos: '+(err.message||err));
                // deixa availableBudgets vazio para indicar erro
                availableBudgets = [];
            }
        }

        function obterOrcamentoAtual(){
            const now = new Date();
            const meses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
            return `${meses[now.getMonth()]}/${String(now.getFullYear()).slice(-2)}`;
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function mostrarMensagem(tipo, texto) {
            const container = document.getElementById('messageContainer');
            if (!container) return;
            
            const message = document.createElement('div');
            message.className = `message ${tipo}`;
            message.textContent = texto;
            
            container.innerHTML = '';
            container.appendChild(message);
            
            // Auto-remover após alguns segundos
            setTimeout(() => {
                message.classList.add('fade-out');
                setTimeout(() => {
                    if (container.contains(message)) {
                        container.removeChild(message);
                    }
                }, 500);
            }, 5000);
        }

        function limparMensagens() {
            const container = document.getElementById('messageContainer');
            if (container) {
                container.innerHTML = '';
            }
        }

        // Estas implementações não são mais necessárias, pois usamos ContasManager 
        // Funções de fallback do googleSheetsService removidas

        // Este método foi substituído pela implementação do ContasManager
        // Implementação getAccountBalancesByBudget removida
    </script>
</body>

</html>
