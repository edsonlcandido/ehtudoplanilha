import{v as A,p as b,A as S,b as C,d as I}from"./auth.js";/* empty css     */import{a as _,s as v}from"./toast.js";import{r as k}from"./user-menu.js";const s={categories:[],isLoading:!1,isSaving:!1,editIndex:-1,deleteIndex:-1};function H(){const e=document.getElementById("loadingIndicator"),t=document.getElementById("categoriesContainer");e&&(e.style.display="flex"),t&&(t.style.display="none")}function N(){const e=document.getElementById("loadingIndicator"),t=document.getElementById("categoriesContainer");e&&(e.style.display="none"),t&&(t.style.display="grid")}function m(e){const t=document.getElementById("saveStatus"),a=document.getElementById("saveStatusText");if(!(!t||!a))switch(t.classList.remove("categorias__status--saving","categorias__status--saved","categorias__status--error"),e){case"saving":t.style.display="flex",t.classList.add("categorias__status--saving"),a.textContent="â³ Salvando...";break;case"saved":t.style.display="flex",t.classList.add("categorias__status--saved"),a.textContent="âœ… Salvo",setTimeout(()=>m("hidden"),2e3);break;case"error":t.style.display="flex",t.classList.add("categorias__status--error"),a.textContent="âŒ Erro ao salvar";break;case"hidden":t.style.display="none";break}}function O(e){const t=(e||"").toUpperCase();let a="categoria-card__type-badge--default",o=e||"NÃ£o definido";return t==="RECEITA"?(a="categoria-card__type-badge--receita",o="Receita"):t==="DESPESA"&&(a="categoria-card__type-badge--despesa",o="Despesa"),`<span class="categoria-card__type-badge ${a}">${o}</span>`}function g(){const e=document.getElementById("categoriesContainer");if(!e)return;if(s.categories.length===0){e.innerHTML=`
      <div class="categorias__empty" style="grid-column: 1 / -1;">
        <div class="categorias__empty-icon">ğŸ·ï¸</div>
        <p class="categorias__empty-text">Nenhuma categoria encontrada</p>
        <p>Clique em "Nova Categoria" para adicionar a primeira.</p>
      </div>
    `;return}const t=s.categories.map((o,n)=>`
    <div class="categoria-card" 
         draggable="true" 
         data-index="${n}">
      <div class="categoria-card__drag-handle" title="Arraste para reordenar">
        â‹®â‹®
      </div>
      <div class="categoria-card__content">
        <div class="categoria-card__name">${q(o.categoria)}</div>
        <div class="categoria-card__type">
          ${O(o.tipo)}
        </div>
      </div>
      <div class="categoria-card__actions">
        <button class="categoria-card__action categoria-card__action--edit" 
                title="Editar categoria"
                data-action="edit"
                data-index="${n}">
          âœï¸
        </button>
        <button class="categoria-card__action categoria-card__action--delete" 
                title="Excluir categoria"
                data-action="delete"
                data-index="${n}">
          ğŸ—‘ï¸
        </button>
      </div>
    </div>
  `).join(""),a=`
    <button class="categorias__add-card" data-action="add">
      <span class="categorias__add-card-icon">â•</span>
      <span>Nova Categoria</span>
    </button>
  `;e.innerHTML=t+a,U(),P()}function q(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function P(){const e=document.getElementById("categoriesContainer");e&&(e.removeEventListener("click",T),e.addEventListener("click",T))}function T(e){const a=e.target.closest("[data-action]");if(!a)return;const o=a.dataset.action,n=a.dataset.index?parseInt(a.dataset.index,10):-1;switch(o){case"edit":n>=0&&K(n);break;case"delete":n>=0&&Q(n);break;case"add":D();break}}let c=null;function U(){const e=document.getElementById("categoriesContainer");if(!e)return;e.querySelectorAll('.categoria-card[draggable="true"]').forEach(a=>{a.addEventListener("dragstart",$),a.addEventListener("dragend",z),a.addEventListener("dragover",R),a.addEventListener("dragenter",F),a.addEventListener("dragleave",G),a.addEventListener("drop",V)})}function $(e){const t=e.currentTarget;c=parseInt(t.dataset.index||"-1",10),t.classList.add("categoria-card--dragging"),e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",String(c)))}function z(e){e.currentTarget.classList.remove("categoria-card--dragging"),c=null,document.querySelectorAll(".categoria-card--drag-over").forEach(a=>{a.classList.remove("categoria-card--drag-over")})}function R(e){e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move")}function F(e){e.preventDefault();const t=e.currentTarget,a=parseInt(t.dataset.index||"-1",10);c!==null&&a!==c&&t.classList.add("categoria-card--drag-over")}function G(e){e.currentTarget.classList.remove("categoria-card--drag-over")}async function V(e){e.preventDefault();const t=e.currentTarget;t.classList.remove("categoria-card--drag-over");const a=parseInt(t.dataset.index||"-1",10);if(c===null||a===-1||c===a)return;const[o]=s.categories.splice(c,1);s.categories.splice(a,0,o),g(),await L()}async function B(e=!1){if(!s.isLoading){s.isLoading=!0,H();try{const t=await b.send(S.getSheetCategoriesComplete,{method:"GET"});s.categories=(t.categoriesComplete||[]).map(a=>({categoria:a.categoria,tipo:a.tipo})),g(),e&&_("Categorias atualizadas com sucesso")}catch(t){const a=t instanceof Error?t.message:"Erro desconhecido";console.error("Erro ao carregar categorias:",t),v("Erro ao carregar categorias: "+a),s.categories=[],g()}finally{s.isLoading=!1,N()}}}async function L(){if(s.isSaving)return!1;s.isSaving=!0,m("saving");try{if(!(await b.send(S.postCategories,{method:"POST",body:{categories:s.categories}})).success)throw new Error("Erro ao salvar categorias");return C.clear(I.SHEET_CATEGORIES),C.clear(I.SHEET_CATEGORIES_COMPLETE),m("saved"),!0}catch(e){const t=e instanceof Error?e.message:"Erro desconhecido";return console.error("Erro ao salvar categorias:",e),m("error"),v("Erro ao salvar categorias: "+t),!1}finally{s.isSaving=!1}}function M(){const e=C.get(I.SHEET_CATEGORIES_COMPLETE);let t=[];e&&e.categoriesComplete&&(t=e.categoriesComplete),t=[...t,...s.categories];const a=new Set;return t.forEach(o=>{o.tipo&&o.tipo.trim()!==""&&a.add(o.tipo.toUpperCase())}),a.size===0&&(a.add("RECEITA"),a.add("DESPESA")),Array.from(a).sort()}function j(){const e=document.querySelector(".categoria-modal__field--autocomplete");if(!e)throw new Error("Campo de autocomplete nÃ£o encontrado");let t=document.getElementById("typeSuggestions");return t||(t=document.createElement("div"),t.id="typeSuggestions",t.classList.add("categoria-modal__suggestions"),t.setAttribute("role","listbox"),e.appendChild(t)),t}function w(e,t){const a=M();if(t.innerHTML="",a.length===0){t.classList.remove("categoria-modal__suggestions--visible");return}a.forEach(o=>{const n=document.createElement("div");n.setAttribute("role","option"),n.classList.add("categoria-modal__suggestion"),n.textContent=o.charAt(0).toUpperCase()+o.slice(1).toLowerCase(),n.addEventListener("click",()=>{e.value=o,t.classList.remove("categoria-modal__suggestions--visible"),e.focus()}),t.appendChild(n)}),t.classList.add("categoria-modal__suggestions--visible")}function x(e,t){const a=e.value.trim().toLowerCase(),o=M();if(t.innerHTML="",!a||a.length<1){w(e,t);return}const n=o.filter(r=>r.toLowerCase().includes(a));if(n.length===0){t.classList.remove("categoria-modal__suggestions--visible");return}n.forEach(r=>{const i=document.createElement("div");i.setAttribute("role","option"),i.classList.add("categoria-modal__suggestion"),i.textContent=r.charAt(0).toUpperCase()+r.slice(1).toLowerCase(),i.addEventListener("click",()=>{e.value=r,t.classList.remove("categoria-modal__suggestions--visible"),e.focus()}),t.appendChild(i)}),t.classList.add("categoria-modal__suggestions--visible")}function J(){const e=document.getElementById("categoryType");if(!e)return;const t=j();e.addEventListener("focus",()=>{e.value.trim().toLowerCase()?x(e,t):w(e,t)}),e.addEventListener("input",()=>{x(e,t)}),e.addEventListener("blur",()=>{setTimeout(()=>{t.classList.remove("categoria-modal__suggestions--visible")},200)})}function D(){s.editIndex=-1;const e=document.getElementById("categoryModal"),t=document.getElementById("categoryModalTitle"),a=document.getElementById("categoryName"),o=document.getElementById("categoryType"),n=document.getElementById("categoryEditIndex");t&&(t.textContent="Nova Categoria"),a&&(a.value=""),o&&(o.value=""),n&&(n.value="-1"),e&&e.classList.add("categoria-modal--visible"),a&&a.focus()}function K(e){const t=s.categories[e];if(!t)return;s.editIndex=e;const a=document.getElementById("categoryModal"),o=document.getElementById("categoryModalTitle"),n=document.getElementById("categoryName"),r=document.getElementById("categoryType"),i=document.getElementById("categoryEditIndex");o&&(o.textContent="Editar Categoria"),n&&(n.value=t.categoria),r&&(r.value=t.tipo||""),i&&(i.value=String(e)),a&&a.classList.add("categoria-modal--visible"),n&&n.focus()}function f(){const e=document.getElementById("categoryModal");e&&e.classList.remove("categoria-modal--visible"),s.editIndex=-1}async function Y(){const e=document.getElementById("categoryName"),t=document.getElementById("categoryType"),a=document.getElementById("categoryEditIndex"),o=e==null?void 0:e.value.trim(),n=(t==null?void 0:t.value.trim().toUpperCase())||"",r=parseInt((a==null?void 0:a.value)||"-1",10);if(!o){v("O nome da categoria Ã© obrigatÃ³rio");return}if(s.categories.findIndex((u,l)=>u.categoria.toLowerCase()===o.toLowerCase()&&l!==r)!==-1){v("JÃ¡ existe uma categoria com este nome");return}r===-1?s.categories.push({categoria:o,tipo:n}):s.categories[r]={categoria:o,tipo:n},f(),g(),await L()&&_(r===-1?"Categoria adicionada com sucesso":"Categoria atualizada com sucesso")}function Q(e){const t=s.categories[e];if(!t)return;s.deleteIndex=e;const a=document.getElementById("deleteCategoryModal"),o=document.getElementById("deleteCategoryName"),n=document.getElementById("deleteCategoryIndex");o&&(o.textContent=t.categoria),n&&(n.value=String(e)),a&&a.classList.add("categoria-modal--visible")}function y(){const e=document.getElementById("deleteCategoryModal");e&&e.classList.remove("categoria-modal--visible"),s.deleteIndex=-1}async function W(){if(s.deleteIndex===-1)return;s.categories.splice(s.deleteIndex,1),y(),g(),await L()&&_("Categoria excluÃ­da com sucesso")}async function h(){if(console.log("[Categorias] Inicializando pÃ¡gina..."),!await A()){console.warn("âš ï¸ Token invÃ¡lido ou usuÃ¡rio nÃ£o autenticado");return}k();const t=document.getElementById("refreshCategoriesBtn");t&&t.addEventListener("click",async()=>{const d=t.innerHTML;t.disabled=!0,t.innerHTML="â³ Atualizando...";try{await B(!0)}finally{t.disabled=!1,t.innerHTML=d}});const a=document.getElementById("addCategoryBtn");a&&a.addEventListener("click",D);const o=document.getElementById("closeCategoryModal"),n=document.getElementById("cancelCategoryBtn"),r=document.getElementById("categoryForm");o&&o.addEventListener("click",f),n&&n.addEventListener("click",f),r&&r.addEventListener("submit",async d=>{d.preventDefault(),await Y()}),J();const i=document.getElementById("closeDeleteCategoryModal"),E=document.getElementById("cancelDeleteCategoryBtn"),u=document.getElementById("confirmDeleteCategoryBtn");i&&i.addEventListener("click",y),E&&E.addEventListener("click",y),u&&u.addEventListener("click",W);const l=document.getElementById("categoryModal"),p=document.getElementById("deleteCategoryModal");l&&l.addEventListener("click",d=>{d.target===l&&f()}),p&&p.addEventListener("click",d=>{d.target===p&&y()}),await B(),console.log("âœ… PÃ¡gina de categorias inicializada")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",h):h();
