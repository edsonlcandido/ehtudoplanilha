import{p as c,c as a}from"./auth.js";class d{static async listOAuthProviders(){try{return(await c.collection("users").listAuthMethods()).authProviders||[]}catch(o){return console.error("[AuthOAuth] Erro ao listar provedores OAuth:",o),[]}}static async loginWithGoogle(){var o;try{a.isDevelopment&&console.log("[AuthOAuth] Iniciando fluxo OAuth com Google (redirect direto)..."),localStorage.setItem("oauth_return_path",window.location.pathname);const r=await c.collection("users").listAuthMethods();a.isDevelopment&&console.log("[AuthOAuth] Resposta de listAuthMethods:",r);const e=r.authProviders||((o=r.oauth2)==null?void 0:o.providers)||[];if(e.length===0)throw new Error("Nenhum provedor OAuth configurado. Configure o Google OAuth no PocketBase Admin UI.");const t=e.find(l=>l.name==="google");if(!t)throw new Error("Provedor Google não configurado. Habilite-o no PocketBase Admin UI.");a.isDevelopment&&console.log("[AuthOAuth] Provedor Google encontrado:",t);const n=window.location.origin+window.location.pathname,s=encodeURIComponent(n),i=`${t.authUrl}${s}`;a.isDevelopment&&(console.log("[AuthOAuth] Redirect URI:",n),console.log("[AuthOAuth] URL OAuth completa:",i),console.log("[AuthOAuth] Redirecionando para Google OAuth...")),localStorage.setItem("oauth_state",t.state),localStorage.setItem("oauth_code_verifier",t.codeVerifier),window.location.href=i}catch(r){console.error("[AuthOAuth] Erro ao iniciar OAuth:",r),alert((r==null?void 0:r.message)||"Erro ao iniciar login com Google. Verifique se o OAuth está configurado no PocketBase Admin UI.")}}static isOAuthCallback(){const o=new URLSearchParams(window.location.search);return o.has("code")||o.has("error")}static async handleOAuthCallback(){var r;if(!this.isOAuthCallback())return!1;const o=new URLSearchParams(window.location.search);if(o.has("error")){const e=o.get("error"),t=o.get("error_description")||"";return console.error("[AuthOAuth] Erro no callback OAuth:",e,t),window.history.replaceState({},document.title,window.location.pathname),alert(`Erro na autenticação: ${e}${t?": "+t:""}`),localStorage.removeItem("oauth_state"),localStorage.removeItem("oauth_code_verifier"),localStorage.removeItem("oauth_return_path"),!1}try{a.isDevelopment&&(console.log("[AuthOAuth] Processando callback OAuth..."),console.log("[AuthOAuth] Parâmetros da URL:",Object.fromEntries(o)));const e=o.get("code"),t=o.get("state");if(!e)throw new Error("Código OAuth não encontrado no callback");const n=localStorage.getItem("oauth_state");if(t!==n)throw console.error("[AuthOAuth] State inválido. Esperado:",n,"Recebido:",t),new Error("State OAuth inválido. Possível ataque CSRF.");const s=localStorage.getItem("oauth_code_verifier");if(!s)throw new Error("Code verifier não encontrado");a.isDevelopment&&console.log("[AuthOAuth] Trocando código OAuth por tokens...");const i=await c.collection("users").authWithOAuth2Code("google",e,s,window.location.origin+window.location.pathname);return a.isDevelopment&&(console.log("[AuthOAuth] Autenticação bem-sucedida:",i.record.email),console.log("[AuthOAuth] Novo usuário:",(r=i.meta)==null?void 0:r.isNew)),window.history.replaceState({},document.title,window.location.pathname),localStorage.removeItem("oauth_state"),localStorage.removeItem("oauth_code_verifier"),localStorage.removeItem("oauth_return_path"),window.location.href="/dashboard/",!0}catch(e){console.error("[AuthOAuth] Erro ao processar callback OAuth:",e),window.history.replaceState({},document.title,window.location.pathname),localStorage.removeItem("oauth_state"),localStorage.removeItem("oauth_code_verifier"),localStorage.removeItem("oauth_return_path");const t=(e==null?void 0:e.message)||"Erro ao processar autenticação OAuth";return alert(`Erro: ${t}`),!1}}static isAuthenticated(){return c.authStore.isValid}static getCurrentUser(){return c.authStore.model}}export{d as A};
