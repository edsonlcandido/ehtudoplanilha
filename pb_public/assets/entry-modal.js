var y=Object.defineProperty;var f=(c,e,t)=>e in c?y(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var d=(c,e,t)=>f(c,typeof e!="symbol"?e+"":e,t);import{p as u,c as p}from"./auth.js";let l=null;class E{constructor(){d(this,"modal",null);d(this,"form",null);d(this,"callback");d(this,"accounts",[]);d(this,"categories",[]);d(this,"descriptions",[]);d(this,"entries",[])}getTemplate(){return`
      <div id="entryModal" class="entry-modal" aria-hidden="true" style="display: none;">
        <div class="entry-modal__content">
          <button id="closeEntryModal" class="entry-modal__close" aria-label="Fechar modal">√ó</button>
          <h3 class="entry-modal__title">Lan√ßamento de Despesa/Receita</h3>
          <form id="expenseForm" class="entry-modal__form">
            <fieldset>
              <div class="form-group">
                <label for="expenseDate">Data:</label>
                <input type="datetime-local" id="expenseDate" name="data" class="form-control" required>
              </div>
              
              <div class="form-group">
                <label for="expenseAccount">Conta:</label>
                <input type="text" id="expenseAccount" name="conta" class="form-control" placeholder="Ex: Conta Corrente" autocomplete="off" required>
              </div>
              
              <div class="form-group valor-toggle-group">
                <label for="expenseValue">Valor:</label>
                <div class="valor-toggle-container">
                  <button type="button" id="expenseSignBtn" class="button outline entry-toggle entry-toggle--expense" aria-label="Alternar sinal">‚àí</button>
                  <input type="number" id="expenseValue" name="valor" class="form-control" step="0.01" min="0" placeholder="0,00" required>
                  <input type="hidden" id="expenseSignValue" name="sinal" value="‚àí">
                </div>
              </div>
              
              <div class="form-group">
                <label for="expenseDescription">Descri√ß√£o:</label>
                <input type="text" id="expenseDescription" name="descricao" class="form-control" placeholder="Descri√ß√£o da despesa" autocomplete="off" required>
              </div>
              
              <div class="form-group">
                <label for="expenseCategory">Categoria:</label>
                <input type="text" id="expenseCategory" name="categoria" class="form-control" placeholder="Digite uma categoria" autocomplete="off" required>
              </div>
              
              <div class="form-group">
                <label for="expenseBudget">Or√ßamento (data-chave):</label>
                <input type="date" id="expenseBudget" name="orcamento" class="form-control" required>
              </div>
              
              <div id="modalFeedback" class="modal-feedback" style="display: none;"></div>
              
              <div class="form-actions">
                <button type="reset" class="button warning">Limpar</button>
                <button type="submit" class="button success">Salvar</button>
              </div>
            </fieldset>
          </form>
        </div>
      </div>
    `}async init(e){if(console.log("[EntryModal] Inicializando..."),this.callback=e,document.body.insertAdjacentHTML("beforeend",this.getTemplate()),this.modal=document.getElementById("entryModal"),this.form=document.getElementById("expenseForm"),!this.modal||!this.form)throw new Error("[EntryModal] Elementos do modal n√£o encontrados");this.setupEventListeners(),this.setSignState(!0),await this.loadAutocompleteData(),console.log("[EntryModal] ‚úÖ Inicializado com sucesso")}setupEventListeners(){var o,s,a;const e=document.getElementById("closeEntryModal");e==null||e.addEventListener("click",()=>this.close()),(o=this.modal)==null||o.addEventListener("click",n=>{n.target===this.modal&&this.close()}),document.addEventListener("keydown",n=>{var r;n.key==="Escape"&&((r=this.modal)==null?void 0:r.style.display)==="flex"&&this.close()});const t=document.getElementById("expenseSignBtn");t==null||t.addEventListener("click",()=>this.toggleSign()),(s=this.form)==null||s.addEventListener("submit",n=>this.handleSubmit(n)),(a=this.form)==null||a.addEventListener("reset",()=>{setTimeout(()=>this.setSignState(!0),0)}),this.setupCategoryAutocomplete(),this.setupDescriptionAutocomplete(),this.setupAccountAutocomplete()}setupCategoryAutocomplete(){const e=document.getElementById("expenseCategory");if(!e)return;let t=this.ensureSuggestionsContainer("catSuggestions",e);e.addEventListener("focus",()=>{this.categories.length>0&&this.showAllSuggestions(e,t,this.categories)}),e.addEventListener("input",()=>{this.showSuggestions(e,t,this.categories)}),e.addEventListener("blur",()=>{setTimeout(()=>t.style.display="none",200)})}setupDescriptionAutocomplete(){const e=document.getElementById("expenseDescription");if(!e)return;let t=this.ensureSuggestionsContainer("descSuggestions",e);e.addEventListener("focus",()=>{this.descriptions.length>0&&(e.value.trim().toLowerCase()||this.showAllSuggestions(e,t,this.descriptions,s=>{this.autoFillCategoryFromDescription(s)}))}),e.addEventListener("input",()=>{this.showSuggestions(e,t,this.descriptions,o=>{this.autoFillCategoryFromDescription(o)})}),e.addEventListener("blur",()=>{setTimeout(()=>t.style.display="none",200)})}autoFillCategoryFromDescription(e){const t=this.entries.find(o=>o.descricao&&o.descricao.trim().toLowerCase()===e.toLowerCase());if(t&&t.categoria){const o=document.getElementById("expenseCategory");o&&(o.value=t.categoria)}}setupAccountAutocomplete(){const e=document.getElementById("expenseAccount");if(!e)return;let t=this.ensureSuggestionsContainer("accountSuggestions",e);e.addEventListener("focus",()=>{this.accounts.length>0&&(e.value.trim().toLowerCase()||this.showAllSuggestions(e,t,this.accounts))}),e.addEventListener("input",()=>{this.showSuggestions(e,t,this.accounts)}),e.addEventListener("blur",()=>{setTimeout(()=>t.style.display="none",200)})}ensureSuggestionsContainer(e,t){let o=document.getElementById(e);if(!o){o=document.createElement("div"),o.id=e,o.classList.add("entry-modal__suggestions"),o.setAttribute("role","listbox");const s=t.parentElement;s&&(s.style.position=s.style.position||"relative",s.appendChild(o))}return o}showAllSuggestions(e,t,o,s){if(t.innerHTML="",o.length===0){t.style.display="none";return}o.slice(0,20).forEach(n=>{const r=document.createElement("div");r.setAttribute("role","option"),r.classList.add("entry-modal__suggestion"),r.textContent=n,r.addEventListener("click",()=>{e.value=n,t.style.display="none",e.focus(),s&&s(n)}),t.appendChild(r)}),t.style.display="block"}showSuggestions(e,t,o,s){t.innerHTML="";const a=e.value.trim().toLowerCase();if(!a||a.length<1){this.showAllSuggestions(e,t,o,s);return}if(o.length===0){t.style.display="none";return}const n=o.filter(r=>r.toLowerCase().includes(a));if(n.length===0){t.style.display="none";return}n.forEach(r=>{const i=document.createElement("div");i.setAttribute("role","option"),i.classList.add("entry-modal__suggestion"),i.textContent=r,i.addEventListener("click",()=>{e.value=r,t.style.display="none",e.focus(),s&&s(r)}),t.appendChild(i)}),t.style.display="block"}async loadAutocompleteData(){console.log("[EntryModal] üì¶ Carregando dados para autocomplete..."),console.log("[EntryModal] Auth token:",u.authStore.token?"Presente":"Ausente");try{const e=`${p.pocketbaseUrl}/get-sheet-entries?limit=0`;console.log("[EntryModal] Buscando entries de:",e);const t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json",Authorization:u.authStore.token?`Bearer ${u.authStore.token}`:""}});if(t.ok){const a=await t.json();this.entries=(a==null?void 0:a.entries)??[],console.log("[EntryModal] Entries recebidos:",this.entries.length),this.accounts=[...new Set(this.entries.map(n=>n.conta).filter(n=>n&&n.trim()))].sort(),console.log("[EntryModal] Contas extra√≠das:",this.accounts),this.descriptions=[...new Set(this.entries.map(n=>n.descricao).filter(n=>n&&n.trim()))].sort(),console.log("[EntryModal] Descri√ß√µes extra√≠das:",this.descriptions.length)}else{console.warn("[EntryModal] ‚ö†Ô∏è Erro ao buscar entries:",t.status,t.statusText);const a=await t.text();console.warn("[EntryModal] Resposta:",a)}const o=`${p.pocketbaseUrl}/get-sheet-categories`;console.log("[EntryModal] Buscando categorias de:",o);const s=await fetch(o,{method:"GET",headers:{"Content-Type":"application/json",Authorization:u.authStore.token?`Bearer ${u.authStore.token}`:""}});if(s.ok){const a=await s.json();this.categories=a!=null&&a.success&&Array.isArray(a.categories)?a.categories:[],console.log("[EntryModal] Categorias recebidas:",this.categories)}else{console.warn("[EntryModal] ‚ö†Ô∏è Erro ao buscar categorias:",s.status,s.statusText);const a=await s.text();console.warn("[EntryModal] Resposta:",a)}console.log("[EntryModal] ‚úÖ Dados carregados:",{accounts:this.accounts.length,categories:this.categories.length,descriptions:this.descriptions.length})}catch(e){console.error("[EntryModal] ‚ö†Ô∏è Erro ao carregar dados:",e)}}toggleSign(){var o;const e=document.getElementById("expenseSignBtn"),t=((o=e==null?void 0:e.textContent)==null?void 0:o.trim())==="‚àí";this.setSignState(!t)}formatDateTimeLocal(e){const[t,o]=e.split("T"),[s,a,n]=t.split("-");return`${n}/${a}/${s} ${o}`}formatDate(e){const[t,o,s]=e.split("-");return`${s}/${o}/${t}`}setSignState(e){const t=document.getElementById("expenseSignBtn"),o=document.getElementById("expenseSignValue");!t||!o||(e?(t.textContent="‚àí",t.classList.add("entry-toggle--expense"),t.classList.remove("entry-toggle--income"),o.value="‚àí"):(t.textContent="+",t.classList.remove("entry-toggle--expense"),t.classList.add("entry-toggle--income"),o.value="+"))}async handleSubmit(e){var h;if(e.preventDefault(),!this.form)return;const t=new FormData(this.form),o=t.get("data"),s=t.get("orcamento"),a=t.get("valor"),n=this.formatDateTimeLocal(o),r=this.formatDate(s),i={data:n,conta:t.get("conta"),valor:parseFloat(a),descricao:t.get("descricao"),categoria:t.get("categoria"),orcamento:r},m=(h=document.getElementById("expenseSignValue"))==null?void 0:h.value,g=m==="‚àí"||m==="-"?-1:1;i.valor=g*Math.abs(i.valor),await this.submitEntry(i)}async submitEntry(e){var t;this.showFeedback("Enviando...","info"),this.setFormDisabled(!0);try{const o={data:e.data,conta:e.conta,valor:e.valor,descricao:e.descricao,categoria:e.categoria,orcamento:e.orcamento};console.log("[EntryModal] üì§ Enviando:",o);const s=await fetch(`${p.pocketbaseUrl}/append-entry`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:u.authStore.token?`Bearer ${u.authStore.token}`:""},body:JSON.stringify(o)}),a=await s.json();if(!s.ok)throw new Error(a.message||"Erro ao adicionar lan√ßamento");console.log("[EntryModal] ‚úÖ Sucesso:",a),this.showFeedback("‚úÖ Lan√ßamento adicionado com sucesso!","success"),(t=this.form)==null||t.reset(),this.setSignState(!0),this.callback&&this.callback(a),setTimeout(()=>this.close(),1500)}catch(o){console.error("[EntryModal] ‚ùå Erro:",o),this.showFeedback(`‚ùå Erro: ${o instanceof Error?o.message:"Erro desconhecido"}`,"error")}finally{this.setFormDisabled(!1)}}showFeedback(e,t){const o=document.getElementById("modalFeedback");o&&(o.textContent=e,o.className=`modal-feedback modal-feedback--${t}`,o.style.display="block",(t==="success"||t==="error")&&setTimeout(()=>{o.style.display="none"},5e3))}setFormDisabled(e){if(!this.form)return;this.form.querySelectorAll("input, button, select, textarea").forEach(o=>{o.disabled=e})}open(){var o;if(!this.modal)return;console.log("[EntryModal] Modal aberto"),this.modal.style.display="flex",this.modal.setAttribute("aria-hidden","false");const e=document.getElementById("openEntryModal");e?(e.classList.add("modal-open"),console.log("[EntryModal] ‚úÖ Classe modal-open adicionada ao bot√£o FAB")):console.warn("[EntryModal] ‚ö†Ô∏è Bot√£o FAB n√£o encontrado"),this.fillCurrentDateTime(),this.fillNextBudget();const t=(o=this.form)==null?void 0:o.querySelector("input");t==null||t.focus(),this.setSignState(!0)}close(){if(!this.modal)return;console.log("[EntryModal] Modal fechado"),this.modal.style.display="none",this.modal.setAttribute("aria-hidden","true");const e=document.getElementById("openEntryModal");e?(e.classList.remove("modal-open"),console.log("[EntryModal] ‚úÖ Classe modal-open removida do bot√£o FAB")):console.warn("[EntryModal] ‚ö†Ô∏è Bot√£o FAB n√£o encontrado");const t=document.getElementById("modalFeedback");t&&(t.style.display="none")}fillCurrentDateTime(){const e=document.getElementById("expenseDate");if(!e)return;const t=new Date,o=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0");e.value=`${o}-${s}-${a}T${n}:${r}`}fillNextBudget(){const e=document.getElementById("expenseBudget");if(!e)return;const t=[...new Set(this.entries.map(n=>n.orcamento).filter(n=>n!=null&&!isNaN(Number(n))).map(n=>Number(n)))].sort((n,r)=>n-r);if(t.length===0){const n=new Date,r=n.getFullYear(),i=String(n.getMonth()+1).padStart(2,"0");e.value=`${r}-${i}-01`;return}const s=Math.floor((new Date().getTime()-new Date(1899,11,31).getTime())/864e5)+1,a=t.find(n=>n>=s);if(a){const n=new Date(1899,11,31);n.setDate(n.getDate()+a-1);const r=n.getFullYear(),i=String(n.getMonth()+1).padStart(2,"0"),m=String(n.getDate()).padStart(2,"0");e.value=`${r}-${i}-${m}`}else{const n=t[t.length-1],r=new Date(1899,11,31);r.setDate(r.getDate()+n-1);const i=r.getFullYear(),m=String(r.getMonth()+1).padStart(2,"0"),g=String(r.getDate()).padStart(2,"0");e.value=`${i}-${m}-${g}`}}}async function S(c){return l?(console.warn("[EntryModal] Modal j√° inicializado"),l):(l=new E,await l.init(c),l)}function w(){if(!l){console.error("[EntryModal] Modal n√£o inicializado. Chame initEntryModal() primeiro.");return}l.open()}function x(){if(!l){console.error("[EntryModal] Modal n√£o inicializado.");return}l.close()}export{x as c,S as i,w as o};
