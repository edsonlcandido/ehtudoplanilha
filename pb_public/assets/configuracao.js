import{p as m,A as p,c as f,v as S}from"./auth.js";import{S as l}from"./sheets.js";import{r as v}from"./user-menu.js";import{s as i,a as u}from"./toast.js";class y{static async getEnvVariables(){try{const t=await m.send(p.envVariables,{method:"GET"});return{clientId:t.GOOGLE_CLIENT_ID,redirectUri:t.GOOGLE_REDIRECT_URI,scopes:f.googleOAuthScopes}}catch(t){throw console.error("[GoogleOAuth] Erro ao obter vari√°veis de ambiente:",t),t}}static async buildAuthUrl(t){console.log("[GoogleOAuth] Obtendo vari√°veis de ambiente...");const a=await this.getEnvVariables();if(console.log("[GoogleOAuth] Vari√°veis obtidas:",{clientId:a.clientId?"‚úì OK":"‚úó UNDEFINED",redirectUri:a.redirectUri?"‚úì OK":"‚úó UNDEFINED",scopes:a.scopes}),!a.clientId||!a.redirectUri)throw new Error("Client ID ou Redirect URI n√£o configurados no backend");const r=`https://accounts.google.com/o/oauth2/v2/auth?${new URLSearchParams({client_id:a.clientId,redirect_uri:a.redirectUri,response_type:"code",scope:a.scopes,access_type:"offline",prompt:"consent",state:t}).toString()}`;return console.log("[GoogleOAuth] URL de autoriza√ß√£o constru√≠da:",r),r}static async startAuthFlow(t){try{const a=await this.buildAuthUrl(t);window.location.href=a}catch(a){throw console.error("[GoogleOAuth] Erro ao iniciar fluxo OAuth:",a),a}}static hasAuthCode(){return new URLSearchParams(window.location.search).has("code")}static getAuthCode(){return new URLSearchParams(window.location.search).get("code")}static getState(){return new URLSearchParams(window.location.search).get("state")}static hasAuthError(){return new URLSearchParams(window.location.search).has("error")}static getAuthError(){return new URLSearchParams(window.location.search).get("error")}static clearUrlParams(){if(window.history&&window.history.replaceState){const t=new URL(window.location.href);t.searchParams.delete("code"),t.searchParams.delete("state"),t.searchParams.delete("error"),t.searchParams.delete("scope"),window.history.replaceState({},document.title,t.toString())}}static handleCallback(){return this.hasAuthError()?{success:!1,error:this.getAuthError()||"Erro desconhecido na autoriza√ß√£o"}:this.hasAuthCode()?(this.clearUrlParams(),{success:!0}):{success:!1,error:"Sem c√≥digo de autoriza√ß√£o"}}}let n={hasRefreshToken:!1,hasSheetId:!1};const e={googleAuthButton:document.getElementById("google-auth-button"),revokeAuthButton:document.getElementById("revoke-auth-button"),currentSheetName:document.getElementById("current-sheet-name"),currentSheetDescription:document.getElementById("current-sheet-description"),openSheetLink:document.getElementById("openSheetLink"),createSheetButton:document.getElementById("create-sheet-button"),sheetsList:document.getElementById("sheets-list"),loadSheetsButton:document.getElementById("load-sheets-button")};function g(){e.googleAuthButton&&(n.hasRefreshToken?(e.googleAuthButton.textContent="‚úÖ Conectado ao Google Drive",e.googleAuthButton.classList.remove("primary"),e.googleAuthButton.classList.add("success"),e.googleAuthButton.disabled=!0,e.revokeAuthButton&&(e.revokeAuthButton.style.display="block")):(e.googleAuthButton.textContent="üîë Autorizar com Google",e.googleAuthButton.classList.remove("success"),e.googleAuthButton.classList.add("primary"),e.googleAuthButton.disabled=!1,e.revokeAuthButton&&(e.revokeAuthButton.style.display="none")))}function c(){!e.currentSheetName||!e.currentSheetDescription||(n.hasSheetId&&n.sheetName?(e.currentSheetName.textContent=n.sheetName,e.currentSheetName.style.color="#27ae60",e.currentSheetDescription.textContent="Sua planilha est√° pronta para uso. Clique no bot√£o abaixo para abrir no Google Drive ou alterar a planilha vinculada.",e.openSheetLink&&n.sheetId&&(e.openSheetLink.href=`https://docs.google.com/spreadsheets/d/${n.sheetId}`,e.openSheetLink.style.display="block"),e.createSheetButton&&(e.createSheetButton.style.display="none"),e.loadSheetsButton&&(e.loadSheetsButton.style.display="block"),e.sheetsList&&(e.sheetsList.style.display="none")):(e.currentSheetName.textContent="Nenhuma planilha configurada",e.currentSheetName.style.color="#e74c3c",n.hasRefreshToken?(e.currentSheetDescription.textContent="Crie uma nova planilha ou selecione uma existente no seu Google Drive.",e.createSheetButton&&(e.createSheetButton.style.display="block"),e.loadSheetsButton&&(e.loadSheetsButton.style.display="block")):(e.currentSheetDescription.textContent="Autorize o Google Drive primeiro para gerenciar suas planilhas.",e.createSheetButton&&(e.createSheetButton.style.display="none"),e.loadSheetsButton&&(e.loadSheetsButton.style.display="none")),e.openSheetLink&&(e.openSheetLink.style.display="none")))}async function w(){try{console.log("üîç [loadConfigStatus] Iniciando...");const o=await l.getConfigStatus();console.log("üìä [loadConfigStatus] Status recebido do backend:",o),n={hasRefreshToken:o.hasRefreshToken,hasSheetId:o.hasSheetId,sheetId:o.sheetId,sheetName:o.sheetName},console.log("üìä [loadConfigStatus] PageState atualizado:",n),g(),c(),console.log("‚úÖ Status carregado:",n)}catch(o){console.error("‚ùå Erro ao carregar status:",o),i("Erro ao carregar configura√ß√µes. Tente recarregar a p√°gina.")}}async function A(){try{e.currentSheetDescription&&(e.currentSheetDescription.textContent="‚è≥ Criando sua planilha..."),console.log("üìã Criando nova planilha...");const o=await l.provisionSheet();console.log("‚úÖ Planilha criada:",o);const t=o.sheet_name||o.sheetName||"Planilha Eh Tudo",a=o.sheet_id||o.sheetId;n.hasSheetId=!0,n.sheetId=a,n.sheetName=t,c(),u(`Planilha "${t}" criada com sucesso! Voc√™ j√° pode come√ßar a usar.`)}catch(o){console.error("‚ùå Erro ao criar nova planilha:",o),i((o==null?void 0:o.message)||"Erro ao criar planilha. Tente novamente.")}}async function B(){var o;try{console.log("üìã Listando planilhas do Google Drive..."),e.loadSheetsButton&&(e.loadSheetsButton.disabled=!0,e.loadSheetsButton.textContent="‚è≥ Carregando...");const t=await l.listGoogleSheets();if(console.log("‚úÖ Planilhas encontradas:",t),t.length===0)i("Nenhuma planilha encontrada no seu Google Drive."),e.sheetsList&&(e.sheetsList.innerHTML='<p style="color: #999; text-align: center; padding: 1rem;">Nenhuma planilha encontrada. Crie uma nova ou verifique suas permiss√µes no Google Drive.</p>',e.sheetsList.style.display="block");else if(e.sheetsList){e.sheetsList.innerHTML='<h4 style="margin-bottom: 1rem;">Selecione uma planilha:</h4>';const a=document.createElement("div");a.style.cssText="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;",t.forEach(s=>{const r=document.createElement("button");r.className="button",r.style.cssText="width: 100%; text-align: left; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; border: 1px solid #e0e0e0;";let d="";s.modifiedTime&&(d=new Date(s.modifiedTime).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})),r.innerHTML=`
            <div style="flex: 1; overflow: hidden;">
              <strong style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #333;">${s.name}</strong>
              <small style="color: #666; display: block;">Modificado: ${d||"N/A"}</small>
            </div>
            <span style="color: #27ae60; font-size: 1.2rem;">‚Üí</span>
          `,r.addEventListener("click",()=>E(s.id,s.name)),a.appendChild(r)}),e.sheetsList.appendChild(a),e.sheetsList.style.display="block"}e.loadSheetsButton&&(e.loadSheetsButton.disabled=!1,e.loadSheetsButton.textContent="üîÑ Recarregar Lista")}catch(t){console.error("‚ùå Erro ao listar planilhas:",t);let a="Erro ao listar planilhas. ";(o=t==null?void 0:t.data)!=null&&o.error?a+=t.data.error:t!=null&&t.message?a+=t.message:(t==null?void 0:t.status)===401?a+="Token de acesso expirado. Tente revogar e autorizar novamente.":(t==null?void 0:t.status)===404?a+="Autoriza√ß√£o com Google Drive n√£o encontrada. Autorize primeiro.":(t==null?void 0:t.status)===400?a+="Falha ao acessar Google Drive. Verifique se voc√™ autorizou corretamente e tente revogar e autorizar novamente se necess√°rio.":a+="Tente novamente.",i(a),e.loadSheetsButton&&(e.loadSheetsButton.disabled=!1,e.loadSheetsButton.textContent="üìã Carregar Minhas Planilhas")}}async function E(o,t){try{console.log(`üìã Selecionando planilha: ${t} (${o})`),await l.saveSheetId(o,t),console.log("‚úÖ Planilha selecionada com sucesso"),n.hasSheetId=!0,n.sheetId=o,n.sheetName=t,c(),u(`Planilha "${t}" selecionada com sucesso!`)}catch(a){console.error("‚ùå Erro ao selecionar planilha:",a),i((a==null?void 0:a.message)||"Erro ao selecionar planilha. Tente novamente.")}}async function k(){try{const o=m.authStore.record;if(!(o!=null&&o.id)){i("Usu√°rio n√£o autenticado.");return}console.log("üîë Iniciando fluxo OAuth..."),await y.startAuthFlow(o.id)}catch(o){console.error("‚ùå Erro ao iniciar OAuth:",o),i("Erro ao iniciar autoriza√ß√£o com Google.")}}async function L(){if(confirm(`Tem certeza que deseja revogar a autoriza√ß√£o do Google Drive?

Isso ir√°:
‚Ä¢ Remover todos os tokens de acesso
‚Ä¢ Limpar a configura√ß√£o da planilha
‚Ä¢ Ser√° necess√°rio autorizar novamente para usar o sistema

Deseja continuar?`))try{console.log("üö´ Revogando autoriza√ß√£o Google..."),e.revokeAuthButton&&(e.revokeAuthButton.disabled=!0,e.revokeAuthButton.textContent="‚è≥ Revogando..."),await l.revokeGoogleAccess(),console.log("‚úÖ Autoriza√ß√£o revogada com sucesso"),n.hasRefreshToken=!1,n.hasSheetId=!1,n.sheetId=void 0,n.sheetName=void 0,g(),c(),u(`Autoriza√ß√£o revogada com sucesso!

Para usar o sistema novamente, clique em "üîë Autorizar com Google" e fa√ßa login com sua conta Google.`),setTimeout(()=>{window.location.reload()},3e3)}catch(t){console.error("‚ùå Erro ao revogar autoriza√ß√£o:",t),i((t==null?void 0:t.message)||"Erro ao revogar autoriza√ß√£o. Tente novamente."),e.revokeAuthButton&&(e.revokeAuthButton.disabled=!1,e.revokeAuthButton.textContent="üö´ Revogar Autoriza√ß√£o")}}function b(){var o,t,a,s;(o=e.googleAuthButton)==null||o.addEventListener("click",k),(t=e.revokeAuthButton)==null||t.addEventListener("click",L),(a=e.createSheetButton)==null||a.addEventListener("click",A),(s=e.loadSheetsButton)==null||s.addEventListener("click",B)}async function h(){if(!await S()){console.warn("‚ö†Ô∏è Token inv√°lido ou usu√°rio n√£o autenticado");return}v(),b(),await w(),console.log("‚úÖ P√°gina de configura√ß√£o inicializada")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",h):h();
