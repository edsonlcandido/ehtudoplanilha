import{p as s,A as n,c as p}from"./auth.js";/* empty css          */import{r as S}from"./user-menu.js";class f{static async getEnvVariables(){try{const e=await s.send(n.envVariables,{method:"GET"});return{clientId:e.GOOGLE_CLIENT_ID,redirectUri:e.GOOGLE_REDIRECT_URI,scopes:p.googleOAuthScopes}}catch(e){throw console.error("[GoogleOAuth] Erro ao obter vari√°veis de ambiente:",e),e}}static async buildAuthUrl(e){console.log("[GoogleOAuth] Obtendo vari√°veis de ambiente...");const r=await this.getEnvVariables();if(console.log("[GoogleOAuth] Vari√°veis obtidas:",{clientId:r.clientId?"‚úì OK":"‚úó UNDEFINED",redirectUri:r.redirectUri?"‚úì OK":"‚úó UNDEFINED",scopes:r.scopes}),!r.clientId||!r.redirectUri)throw new Error("Client ID ou Redirect URI n√£o configurados no backend");const u=`https://accounts.google.com/o/oauth2/v2/auth?${new URLSearchParams({client_id:r.clientId,redirect_uri:r.redirectUri,response_type:"code",scope:r.scopes,access_type:"offline",prompt:"consent",state:e}).toString()}`;return console.log("[GoogleOAuth] URL de autoriza√ß√£o constru√≠da:",u),u}static async startAuthFlow(e){try{const r=await this.buildAuthUrl(e);window.location.href=r}catch(r){throw console.error("[GoogleOAuth] Erro ao iniciar fluxo OAuth:",r),r}}static hasAuthCode(){return new URLSearchParams(window.location.search).has("code")}static getAuthCode(){return new URLSearchParams(window.location.search).get("code")}static getState(){return new URLSearchParams(window.location.search).get("state")}static hasAuthError(){return new URLSearchParams(window.location.search).has("error")}static getAuthError(){return new URLSearchParams(window.location.search).get("error")}static clearUrlParams(){if(window.history&&window.history.replaceState){const e=new URL(window.location.href);e.searchParams.delete("code"),e.searchParams.delete("state"),e.searchParams.delete("error"),e.searchParams.delete("scope"),window.history.replaceState({},document.title,e.toString())}}static handleCallback(){return this.hasAuthError()?{success:!1,error:this.getAuthError()||"Erro desconhecido na autoriza√ß√£o"}:this.hasAuthCode()?(this.clearUrlParams(),{success:!0}):{success:!1,error:"Sem c√≥digo de autoriza√ß√£o"}}}class h{static async checkRefreshToken(){try{return(await s.send(n.checkRefreshToken,{method:"GET"})).hasRefreshToken}catch(e){return console.error("[SheetsService] Erro ao verificar refresh token:",e),!1}}static async listGoogleSheets(){try{return(await s.send(n.listGoogleSheets,{method:"GET"})).files||[]}catch(e){throw console.error("[SheetsService] Erro ao listar planilhas:",e),e}}static async saveSheetId(e,r){try{await s.send(n.saveSheetId,{method:"POST",body:{sheetId:e,sheetName:r}})}catch(c){throw console.error("[SheetsService] Erro ao salvar sheet ID:",c),c}}static async provisionSheet(){try{return await s.send(n.provisionSheet,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao provisionar planilha:",e),e}}static async getCurrentSheet(){try{return await s.send(n.getCurrentSheet,{method:"GET"})}catch(e){return console.error("[SheetsService] Erro ao obter planilha atual:",e),{}}}static async getConfigStatus(){try{return await s.send(n.configStatus,{method:"GET"})}catch(e){return console.error("[SheetsService] Erro ao obter status:",e),{hasRefreshToken:!1,hasSheetId:!1}}}static async appendEntry(e){try{await s.send(n.appendEntry,{method:"POST",body:e})}catch(r){throw console.error("[SheetsService] Erro ao adicionar lan√ßamento:",r),r}}static async editEntry(e,r){try{await s.send(n.editSheetEntry,{method:"PUT",body:{rowIndex:e,...r}})}catch(c){throw console.error("[SheetsService] Erro ao editar lan√ßamento:",c),c}}static async deleteEntry(e){try{await s.send(n.deleteSheetEntry,{method:"DELETE",body:{rowIndex:e}})}catch(r){throw console.error("[SheetsService] Erro ao deletar lan√ßamento:",r),r}}static async getSheetEntries(e,r){try{return(await s.send(`${n.getSheetEntries}?month=${e}&year=${r}`,{method:"GET"})).entries||[]}catch(c){throw console.error("[SheetsService] Erro ao obter lan√ßamentos:",c),c}}static async getFinancialSummary(e,r){try{return await s.send(`${n.getFinancialSummary}?month=${e}&year=${r}`,{method:"GET"})}catch(c){throw console.error("[SheetsService] Erro ao obter resumo financeiro:",c),c}}static async getAvailableMonths(){try{return(await s.send(n.getAvailableMonths,{method:"GET"})).months||[]}catch(e){return console.error("[SheetsService] Erro ao obter meses dispon√≠veis:",e),[]}}static async getSheetCategories(){try{return(await s.send(n.getSheetCategories,{method:"GET"})).categories||[]}catch(e){return console.error("[SheetsService] Erro ao obter categorias:",e),[]}}static async clearSheetContent(){try{await s.send(n.clearSheetContent,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao limpar planilha:",e),e}}static async deleteSheetConfig(){try{await s.send(n.deleteSheetConfig,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao deletar configura√ß√£o:",e),e}}static async revokeGoogleAccess(){try{await s.send(n.revokeGoogleAccess,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao revogar acesso:",e),e}}static async refreshToken(){try{await s.send(n.googleRefreshToken,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao renovar token:",e),e}}}let a={hasRefreshToken:!1,hasSheetId:!1};const t={googleAuthButton:document.getElementById("google-auth-button"),revokeAuthButton:document.getElementById("revoke-auth-button"),currentSheetName:document.getElementById("current-sheet-name"),currentSheetDescription:document.getElementById("current-sheet-description"),openSheetLink:document.getElementById("openSheetLink")};function m(){t.googleAuthButton&&(a.hasRefreshToken?(t.googleAuthButton.textContent="‚úÖ Conectado ao Google Drive",t.googleAuthButton.classList.remove("primary"),t.googleAuthButton.classList.add("success"),t.googleAuthButton.disabled=!0,t.revokeAuthButton&&(t.revokeAuthButton.style.display="block")):(t.googleAuthButton.textContent="üîë Autorizar com Google",t.googleAuthButton.classList.remove("success"),t.googleAuthButton.classList.add("primary"),t.googleAuthButton.disabled=!1,t.revokeAuthButton&&(t.revokeAuthButton.style.display="none")))}function l(){!t.currentSheetName||!t.currentSheetDescription||(a.hasSheetId&&a.sheetName?(t.currentSheetName.textContent=a.sheetName,t.currentSheetName.style.color="#27ae60",t.currentSheetDescription.textContent="Sua planilha est√° pronta para uso. Clique no bot√£o abaixo para abrir no Google Drive.",t.openSheetLink&&a.sheetId&&(t.openSheetLink.href=`https://docs.google.com/spreadsheets/d/${a.sheetId}`,t.openSheetLink.style.display="block")):(t.currentSheetName.textContent="Nenhuma planilha configurada",t.currentSheetName.style.color="#e74c3c",a.hasRefreshToken?t.currentSheetDescription.textContent="‚è≥ Criando sua planilha automaticamente...":t.currentSheetDescription.textContent="Autorize o Google Drive para criar sua planilha automaticamente.",t.openSheetLink&&(t.openSheetLink.style.display="none")))}function g(o){const e=document.createElement("div");e.className="alert success",e.style.cssText="position: fixed; top: 80px; right: 20px; z-index: 99999; min-width: 300px; max-width: 500px;",e.innerHTML=`
    <strong>‚úÖ Sucesso!</strong>
    <p>${o}</p>
  `,document.body.appendChild(e),setTimeout(()=>{e.remove()},4e3)}function i(o){const e=document.createElement("div");e.className="alert error",e.style.cssText="position: fixed; top: 80px; right: 20px; z-index: 99999; min-width: 300px; max-width: 500px;",e.innerHTML=`
    <strong>‚ùå Erro!</strong>
    <p>${o}</p>
  `,document.body.appendChild(e),setTimeout(()=>{e.remove()},5e3)}async function y(){try{console.log("üîç [loadConfigStatus] Iniciando...");const o=await h.getConfigStatus();console.log("üìä [loadConfigStatus] Status recebido do backend:",o),a={hasRefreshToken:o.hasRefreshToken,hasSheetId:o.hasSheetId,sheetId:o.sheetId,sheetName:o.sheetName},console.log("üìä [loadConfigStatus] PageState atualizado:",a),m(),l(),console.log("‚úÖ Status carregado:",a),a.hasRefreshToken&&!a.hasSheetId?(console.log("üîÑ Usu√°rio autorizado sem planilha, criando automaticamente..."),console.log("üîÑ hasRefreshToken:",a.hasRefreshToken),console.log("üîÑ hasSheetId:",a.hasSheetId),await v()):(console.log("‚ÑπÔ∏è N√£o criar planilha automaticamente porque:"),console.log("  - hasRefreshToken:",a.hasRefreshToken),console.log("  - hasSheetId:",a.hasSheetId))}catch(o){console.error("‚ùå Erro ao carregar status:",o),i("Erro ao carregar configura√ß√µes. Tente recarregar a p√°gina.")}}async function v(){try{t.currentSheetDescription&&(t.currentSheetDescription.textContent="‚è≥ Criando sua planilha automaticamente..."),console.log("üìã Criando planilha automaticamente...");const o=await h.provisionSheet();console.log("‚úÖ Planilha criada:",o);const e=o.sheet_name||o.sheetName||"Planilha Eh Tudo",r=o.sheet_id||o.sheetId;a.hasSheetId=!0,a.sheetId=r,a.sheetName=e,l(),g(`Planilha "${e}" criada com sucesso! Voc√™ j√° pode come√ßar a usar.`)}catch(o){console.error("‚ùå Erro ao criar planilha automaticamente:",o),i((o==null?void 0:o.message)||"Erro ao criar planilha automaticamente. Tente recarregar a p√°gina.")}}async function E(){try{const o=s.authStore.record;if(!(o!=null&&o.id)){i("Usu√°rio n√£o autenticado.");return}console.log("üîë Iniciando fluxo OAuth..."),await f.startAuthFlow(o.id)}catch(o){console.error("‚ùå Erro ao iniciar OAuth:",o),i("Erro ao iniciar autoriza√ß√£o com Google.")}}async function w(){if(confirm(`Tem certeza que deseja revogar a autoriza√ß√£o do Google Drive?

Isso ir√°:
‚Ä¢ Remover todos os tokens de acesso
‚Ä¢ Limpar a configura√ß√£o da planilha
‚Ä¢ Ser√° necess√°rio autorizar novamente para usar o sistema

Deseja continuar?`))try{console.log("üö´ Revogando autoriza√ß√£o Google..."),t.revokeAuthButton&&(t.revokeAuthButton.disabled=!0,t.revokeAuthButton.textContent="‚è≥ Revogando..."),await h.revokeGoogleAccess(),console.log("‚úÖ Autoriza√ß√£o revogada com sucesso"),a.hasRefreshToken=!1,a.hasSheetId=!1,a.sheetId=void 0,a.sheetName=void 0,m(),l(),g("Autoriza√ß√£o revogada com sucesso! Voc√™ pode autorizar novamente quando quiser.")}catch(e){console.error("‚ùå Erro ao revogar autoriza√ß√£o:",e),i((e==null?void 0:e.message)||"Erro ao revogar autoriza√ß√£o. Tente novamente."),t.revokeAuthButton&&(t.revokeAuthButton.disabled=!1,t.revokeAuthButton.textContent="üö´ Revogar Autoriza√ß√£o")}}function A(){var o,e;(o=t.googleAuthButton)==null||o.addEventListener("click",E),(e=t.revokeAuthButton)==null||e.addEventListener("click",w)}async function d(){S(),A(),await y(),console.log("‚úÖ P√°gina de configura√ß√£o inicializada")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",d):d();
