import{p as a,A as n,c as m}from"./auth.js";/* empty css          */import{r as g}from"./user-menu.js";class S{static async getEnvVariables(){try{const e=await a.send(n.envVariables,{method:"GET"});return{clientId:e.GOOGLE_CLIENT_ID,redirectUri:e.GOOGLE_REDIRECT_URI,scopes:m.googleOAuthScopes}}catch(e){throw console.error("[GoogleOAuth] Erro ao obter vari√°veis de ambiente:",e),e}}static async buildAuthUrl(e){console.log("[GoogleOAuth] Obtendo vari√°veis de ambiente...");const r=await this.getEnvVariables();if(console.log("[GoogleOAuth] Vari√°veis obtidas:",{clientId:r.clientId?"‚úì OK":"‚úó UNDEFINED",redirectUri:r.redirectUri?"‚úì OK":"‚úó UNDEFINED",scopes:r.scopes}),!r.clientId||!r.redirectUri)throw new Error("Client ID ou Redirect URI n√£o configurados no backend");const h=`https://accounts.google.com/o/oauth2/v2/auth?${new URLSearchParams({client_id:r.clientId,redirect_uri:r.redirectUri,response_type:"code",scope:r.scopes,access_type:"offline",prompt:"consent",state:e}).toString()}`;return console.log("[GoogleOAuth] URL de autoriza√ß√£o constru√≠da:",h),h}static async startAuthFlow(e){try{const r=await this.buildAuthUrl(e);window.location.href=r}catch(r){throw console.error("[GoogleOAuth] Erro ao iniciar fluxo OAuth:",r),r}}static hasAuthCode(){return new URLSearchParams(window.location.search).has("code")}static getAuthCode(){return new URLSearchParams(window.location.search).get("code")}static getState(){return new URLSearchParams(window.location.search).get("state")}static hasAuthError(){return new URLSearchParams(window.location.search).has("error")}static getAuthError(){return new URLSearchParams(window.location.search).get("error")}static clearUrlParams(){if(window.history&&window.history.replaceState){const e=new URL(window.location.href);e.searchParams.delete("code"),e.searchParams.delete("state"),e.searchParams.delete("error"),e.searchParams.delete("scope"),window.history.replaceState({},document.title,e.toString())}}static handleCallback(){return this.hasAuthError()?{success:!1,error:this.getAuthError()||"Erro desconhecido na autoriza√ß√£o"}:this.hasAuthCode()?(this.clearUrlParams(),{success:!0}):{success:!1,error:"Sem c√≥digo de autoriza√ß√£o"}}}class d{static async checkRefreshToken(){try{return(await a.send(n.checkRefreshToken,{method:"GET"})).hasRefreshToken}catch(e){return console.error("[SheetsService] Erro ao verificar refresh token:",e),!1}}static async listGoogleSheets(){try{return(await a.send(n.listGoogleSheets,{method:"GET"})).files||[]}catch(e){throw console.error("[SheetsService] Erro ao listar planilhas:",e),e}}static async saveSheetId(e,r){try{await a.send(n.saveSheetId,{method:"POST",body:{sheetId:e,sheetName:r}})}catch(c){throw console.error("[SheetsService] Erro ao salvar sheet ID:",c),c}}static async provisionSheet(){try{return await a.send(n.provisionSheet,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao provisionar planilha:",e),e}}static async getCurrentSheet(){try{return await a.send(n.getCurrentSheet,{method:"GET"})}catch(e){return console.error("[SheetsService] Erro ao obter planilha atual:",e),{}}}static async getConfigStatus(){try{return await a.send(n.configStatus,{method:"GET"})}catch(e){return console.error("[SheetsService] Erro ao obter status:",e),{hasRefreshToken:!1,hasSheetId:!1}}}static async appendEntry(e){try{await a.send(n.appendEntry,{method:"POST",body:e})}catch(r){throw console.error("[SheetsService] Erro ao adicionar lan√ßamento:",r),r}}static async editEntry(e,r){try{await a.send(n.editSheetEntry,{method:"PUT",body:{rowIndex:e,...r}})}catch(c){throw console.error("[SheetsService] Erro ao editar lan√ßamento:",c),c}}static async deleteEntry(e){try{await a.send(n.deleteSheetEntry,{method:"DELETE",body:{rowIndex:e}})}catch(r){throw console.error("[SheetsService] Erro ao deletar lan√ßamento:",r),r}}static async getSheetEntries(e,r){try{return(await a.send(`${n.getSheetEntries}?month=${e}&year=${r}`,{method:"GET"})).entries||[]}catch(c){throw console.error("[SheetsService] Erro ao obter lan√ßamentos:",c),c}}static async getFinancialSummary(e,r){try{return await a.send(`${n.getFinancialSummary}?month=${e}&year=${r}`,{method:"GET"})}catch(c){throw console.error("[SheetsService] Erro ao obter resumo financeiro:",c),c}}static async getAvailableMonths(){try{return(await a.send(n.getAvailableMonths,{method:"GET"})).months||[]}catch(e){return console.error("[SheetsService] Erro ao obter meses dispon√≠veis:",e),[]}}static async getSheetCategories(){try{return(await a.send(n.getSheetCategories,{method:"GET"})).categories||[]}catch(e){return console.error("[SheetsService] Erro ao obter categorias:",e),[]}}static async clearSheetContent(){try{await a.send(n.clearSheetContent,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao limpar planilha:",e),e}}static async deleteSheetConfig(){try{await a.send(n.deleteSheetConfig,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao deletar configura√ß√£o:",e),e}}static async revokeGoogleAccess(){try{await a.send(n.revokeGoogleAccess,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao revogar acesso:",e),e}}static async refreshToken(){try{await a.send(n.googleRefreshToken,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao renovar token:",e),e}}}let s={hasRefreshToken:!1,hasSheetId:!1};const o={googleAuthButton:document.getElementById("google-auth-button"),currentSheetName:document.getElementById("current-sheet-name"),currentSheetDescription:document.getElementById("current-sheet-description"),openSheetLink:document.getElementById("openSheetLink")};function p(){o.googleAuthButton&&(s.hasRefreshToken?(o.googleAuthButton.textContent="‚úÖ Conectado ao Google Drive",o.googleAuthButton.classList.remove("primary"),o.googleAuthButton.classList.add("success"),o.googleAuthButton.disabled=!0):(o.googleAuthButton.textContent="üîë Autorizar com Google",o.googleAuthButton.classList.remove("success"),o.googleAuthButton.classList.add("primary"),o.googleAuthButton.disabled=!1))}function u(){!o.currentSheetName||!o.currentSheetDescription||(s.hasSheetId&&s.sheetName?(o.currentSheetName.textContent=s.sheetName,o.currentSheetName.style.color="#27ae60",o.currentSheetDescription.textContent="Sua planilha est√° pronta para uso. Clique no bot√£o abaixo para abrir no Google Drive.",o.openSheetLink&&s.sheetId&&(o.openSheetLink.href=`https://docs.google.com/spreadsheets/d/${s.sheetId}`,o.openSheetLink.style.display="block")):(o.currentSheetName.textContent="Nenhuma planilha configurada",o.currentSheetName.style.color="#e74c3c",s.hasRefreshToken?o.currentSheetDescription.textContent="‚è≥ Criando sua planilha automaticamente...":o.currentSheetDescription.textContent="Autorize o Google Drive para criar sua planilha automaticamente.",o.openSheetLink&&(o.openSheetLink.style.display="none")))}function y(t){const e=document.createElement("div");e.className="alert success",e.style.cssText="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;",e.innerHTML=`
    <strong>‚úÖ Sucesso!</strong>
    <p>${t}</p>
  `,document.body.appendChild(e),setTimeout(()=>{e.remove()},4e3)}function i(t){const e=document.createElement("div");e.className="alert error",e.style.cssText="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;",e.innerHTML=`
    <strong>‚ùå Erro!</strong>
    <p>${t}</p>
  `,document.body.appendChild(e),setTimeout(()=>{e.remove()},5e3)}async function f(){try{console.log("üîç [loadConfigStatus] Iniciando...");const t=await d.getConfigStatus();console.log("üìä [loadConfigStatus] Status recebido do backend:",t),s={hasRefreshToken:t.hasRefreshToken,hasSheetId:t.hasSheetId,sheetId:t.sheetId,sheetName:t.sheetName},console.log("üìä [loadConfigStatus] PageState atualizado:",s),p(),u(),console.log("‚úÖ Status carregado:",s),s.hasRefreshToken&&!s.hasSheetId?(console.log("üîÑ Usu√°rio autorizado sem planilha, criando automaticamente..."),console.log("üîÑ hasRefreshToken:",s.hasRefreshToken),console.log("üîÑ hasSheetId:",s.hasSheetId),await w()):(console.log("‚ÑπÔ∏è N√£o criar planilha automaticamente porque:"),console.log("  - hasRefreshToken:",s.hasRefreshToken),console.log("  - hasSheetId:",s.hasSheetId))}catch(t){console.error("‚ùå Erro ao carregar status:",t),i("Erro ao carregar configura√ß√µes. Tente recarregar a p√°gina.")}}async function w(){try{o.currentSheetDescription&&(o.currentSheetDescription.textContent="‚è≥ Criando sua planilha automaticamente..."),console.log("üìã Criando planilha automaticamente...");const t=await d.provisionSheet();console.log("‚úÖ Planilha criada:",t),s.hasSheetId=!0,s.sheetId=t.sheetId,s.sheetName=t.sheetName,u(),y(`Planilha "${t.sheetName}" criada com sucesso! Voc√™ j√° pode come√ßar a usar.`)}catch(t){console.error("‚ùå Erro ao criar planilha automaticamente:",t),i((t==null?void 0:t.message)||"Erro ao criar planilha automaticamente. Tente recarregar a p√°gina.")}}async function E(){try{const t=a.authStore.record;if(!(t!=null&&t.id)){i("Usu√°rio n√£o autenticado.");return}console.log("üîë Iniciando fluxo OAuth..."),await S.startAuthFlow(t.id)}catch(t){console.error("‚ùå Erro ao iniciar OAuth:",t),i("Erro ao iniciar autoriza√ß√£o com Google.")}}function v(){var t;(t=o.googleAuthButton)==null||t.addEventListener("click",E)}async function l(){g(),v(),await f(),console.log("‚úÖ P√°gina de configura√ß√£o inicializada")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",l):l();
