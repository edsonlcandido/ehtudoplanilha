import{p as n,A as i,c as y,C as u,b as m}from"./auth.js";/* empty css          */import{r as v}from"./user-menu.js";import{s as l,a as g}from"./toast.js";class E{static async getEnvVariables(){try{const e=await n.send(i.envVariables,{method:"GET"});return{clientId:e.GOOGLE_CLIENT_ID,redirectUri:e.GOOGLE_REDIRECT_URI,scopes:y.googleOAuthScopes}}catch(e){throw console.error("[GoogleOAuth] Erro ao obter vari√°veis de ambiente:",e),e}}static async buildAuthUrl(e){console.log("[GoogleOAuth] Obtendo vari√°veis de ambiente...");const o=await this.getEnvVariables();if(console.log("[GoogleOAuth] Vari√°veis obtidas:",{clientId:o.clientId?"‚úì OK":"‚úó UNDEFINED",redirectUri:o.redirectUri?"‚úì OK":"‚úó UNDEFINED",scopes:o.scopes}),!o.clientId||!o.redirectUri)throw new Error("Client ID ou Redirect URI n√£o configurados no backend");const c=`https://accounts.google.com/o/oauth2/v2/auth?${new URLSearchParams({client_id:o.clientId,redirect_uri:o.redirectUri,response_type:"code",scope:o.scopes,access_type:"offline",prompt:"consent",state:e}).toString()}`;return console.log("[GoogleOAuth] URL de autoriza√ß√£o constru√≠da:",c),c}static async startAuthFlow(e){try{const o=await this.buildAuthUrl(e);window.location.href=o}catch(o){throw console.error("[GoogleOAuth] Erro ao iniciar fluxo OAuth:",o),o}}static hasAuthCode(){return new URLSearchParams(window.location.search).has("code")}static getAuthCode(){return new URLSearchParams(window.location.search).get("code")}static getState(){return new URLSearchParams(window.location.search).get("state")}static hasAuthError(){return new URLSearchParams(window.location.search).has("error")}static getAuthError(){return new URLSearchParams(window.location.search).get("error")}static clearUrlParams(){if(window.history&&window.history.replaceState){const e=new URL(window.location.href);e.searchParams.delete("code"),e.searchParams.delete("state"),e.searchParams.delete("error"),e.searchParams.delete("scope"),window.history.replaceState({},document.title,e.toString())}}static handleCallback(){return this.hasAuthError()?{success:!1,error:this.getAuthError()||"Erro desconhecido na autoriza√ß√£o"}:this.hasAuthCode()?(this.clearUrlParams(),{success:!0}):{success:!1,error:"Sem c√≥digo de autoriza√ß√£o"}}}class h{static async checkRefreshToken(){try{return(await n.send(i.checkRefreshToken,{method:"GET"})).hasRefreshToken}catch(e){return console.error("[SheetsService] Erro ao verificar refresh token:",e),!1}}static async listGoogleSheets(){try{return(await n.send(i.listGoogleSheets,{method:"GET"})).sheets||[]}catch(e){throw console.error("[SheetsService] Erro ao listar planilhas:",e),e}}static async saveSheetId(e,o){try{await n.send(i.saveSheetId,{method:"POST",body:{sheet_id:e,sheet_name:o}})}catch(r){throw console.error("[SheetsService] Erro ao salvar sheet ID:",r),r}}static async provisionSheet(){try{return await n.send(i.provisionSheet,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao provisionar planilha:",e),e}}static async getCurrentSheet(){try{return await n.send(i.getCurrentSheet,{method:"GET"})}catch(e){return console.error("[SheetsService] Erro ao obter planilha atual:",e),{}}}static async getConfigStatus(){try{return await n.send(i.configStatus,{method:"GET"})}catch(e){return console.error("[SheetsService] Erro ao obter status:",e),{hasRefreshToken:!1,hasSheetId:!1}}}static async appendEntry(e){try{await n.send(i.appendEntry,{method:"POST",body:e}),console.log("[SheetsService] Invalidando cache ap√≥s adicionar lan√ßamento"),u.clear(m.SHEET_ENTRIES)}catch(o){throw console.error("[SheetsService] Erro ao adicionar lan√ßamento:",o),o}}static async editEntry(e,o){try{await n.send(i.editSheetEntry,{method:"PUT",body:{rowIndex:e,...o}}),console.log("[SheetsService] Invalidando cache ap√≥s editar lan√ßamento"),u.clear(m.SHEET_ENTRIES)}catch(r){throw console.error("[SheetsService] Erro ao editar lan√ßamento:",r),r}}static async deleteEntry(e){try{await n.send(i.deleteSheetEntry,{method:"DELETE",body:{rowIndex:e}}),console.log("[SheetsService] Invalidando cache ap√≥s deletar lan√ßamento"),u.clear(m.SHEET_ENTRIES)}catch(o){throw console.error("[SheetsService] Erro ao deletar lan√ßamento:",o),o}}static async getSheetEntries(e,o){try{return(await n.send(`${i.getSheetEntries}?month=${e}&year=${o}`,{method:"GET"})).entries||[]}catch(r){throw console.error("[SheetsService] Erro ao obter lan√ßamentos:",r),r}}static async getFinancialSummary(e,o){try{return await n.send(`${i.getFinancialSummary}?month=${e}&year=${o}`,{method:"GET"})}catch(r){throw console.error("[SheetsService] Erro ao obter resumo financeiro:",r),r}}static async getAvailableMonths(){try{return(await n.send(i.getAvailableMonths,{method:"GET"})).months||[]}catch(e){return console.error("[SheetsService] Erro ao obter meses dispon√≠veis:",e),[]}}static async getSheetCategories(){try{return(await n.send(i.getSheetCategories,{method:"GET"})).categories||[]}catch(e){return console.error("[SheetsService] Erro ao obter categorias:",e),[]}}static async clearSheetContent(){try{await n.send(i.clearSheetContent,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao limpar planilha:",e),e}}static async deleteSheetConfig(){try{await n.send(i.deleteSheetConfig,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao deletar configura√ß√£o:",e),e}}static async revokeGoogleAccess(){try{await n.send(i.revokeGoogleAccess,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao revogar acesso:",e),e}}static async refreshToken(){try{await n.send(i.googleRefreshToken,{method:"POST"})}catch(e){throw console.error("[SheetsService] Erro ao renovar token:",e),e}}}let s={hasRefreshToken:!1,hasSheetId:!1};const t={googleAuthButton:document.getElementById("google-auth-button"),revokeAuthButton:document.getElementById("revoke-auth-button"),currentSheetName:document.getElementById("current-sheet-name"),currentSheetDescription:document.getElementById("current-sheet-description"),openSheetLink:document.getElementById("openSheetLink"),createSheetButton:document.getElementById("create-sheet-button"),sheetsList:document.getElementById("sheets-list"),loadSheetsButton:document.getElementById("load-sheets-button")};function f(){t.googleAuthButton&&(s.hasRefreshToken?(t.googleAuthButton.textContent="‚úÖ Conectado ao Google Drive",t.googleAuthButton.classList.remove("primary"),t.googleAuthButton.classList.add("success"),t.googleAuthButton.disabled=!0,t.revokeAuthButton&&(t.revokeAuthButton.style.display="block")):(t.googleAuthButton.textContent="üîë Autorizar com Google",t.googleAuthButton.classList.remove("success"),t.googleAuthButton.classList.add("primary"),t.googleAuthButton.disabled=!1,t.revokeAuthButton&&(t.revokeAuthButton.style.display="none")))}function d(){!t.currentSheetName||!t.currentSheetDescription||(s.hasSheetId&&s.sheetName?(t.currentSheetName.textContent=s.sheetName,t.currentSheetName.style.color="#27ae60",t.currentSheetDescription.textContent="Sua planilha est√° pronta para uso. Clique no bot√£o abaixo para abrir no Google Drive ou alterar a planilha vinculada.",t.openSheetLink&&s.sheetId&&(t.openSheetLink.href=`https://docs.google.com/spreadsheets/d/${s.sheetId}`,t.openSheetLink.style.display="block"),t.createSheetButton&&(t.createSheetButton.style.display="none"),t.loadSheetsButton&&(t.loadSheetsButton.style.display="block"),t.sheetsList&&(t.sheetsList.style.display="none")):(t.currentSheetName.textContent="Nenhuma planilha configurada",t.currentSheetName.style.color="#e74c3c",s.hasRefreshToken?(t.currentSheetDescription.textContent="Crie uma nova planilha ou selecione uma existente no seu Google Drive.",t.createSheetButton&&(t.createSheetButton.style.display="block"),t.loadSheetsButton&&(t.loadSheetsButton.style.display="block")):(t.currentSheetDescription.textContent="Autorize o Google Drive primeiro para gerenciar suas planilhas.",t.createSheetButton&&(t.createSheetButton.style.display="none"),t.loadSheetsButton&&(t.loadSheetsButton.style.display="none")),t.openSheetLink&&(t.openSheetLink.style.display="none")))}async function w(){try{console.log("üîç [loadConfigStatus] Iniciando...");const a=await h.getConfigStatus();console.log("üìä [loadConfigStatus] Status recebido do backend:",a),s={hasRefreshToken:a.hasRefreshToken,hasSheetId:a.hasSheetId,sheetId:a.sheetId,sheetName:a.sheetName},console.log("üìä [loadConfigStatus] PageState atualizado:",s),f(),d(),console.log("‚úÖ Status carregado:",s)}catch(a){console.error("‚ùå Erro ao carregar status:",a),l("Erro ao carregar configura√ß√µes. Tente recarregar a p√°gina.")}}async function A(){try{t.currentSheetDescription&&(t.currentSheetDescription.textContent="‚è≥ Criando sua planilha..."),console.log("üìã Criando nova planilha...");const a=await h.provisionSheet();console.log("‚úÖ Planilha criada:",a);const e=a.sheet_name||a.sheetName||"Planilha Eh Tudo",o=a.sheet_id||a.sheetId;s.hasSheetId=!0,s.sheetId=o,s.sheetName=e,d(),g(`Planilha "${e}" criada com sucesso! Voc√™ j√° pode come√ßar a usar.`)}catch(a){console.error("‚ùå Erro ao criar nova planilha:",a),l((a==null?void 0:a.message)||"Erro ao criar planilha. Tente novamente.")}}async function k(){var a;try{console.log("üìã Listando planilhas do Google Drive..."),t.loadSheetsButton&&(t.loadSheetsButton.disabled=!0,t.loadSheetsButton.textContent="‚è≥ Carregando...");const e=await h.listGoogleSheets();if(console.log("‚úÖ Planilhas encontradas:",e),e.length===0)l("Nenhuma planilha encontrada no seu Google Drive."),t.sheetsList&&(t.sheetsList.innerHTML='<p style="color: #999; text-align: center; padding: 1rem;">Nenhuma planilha encontrada. Crie uma nova ou verifique suas permiss√µes no Google Drive.</p>',t.sheetsList.style.display="block");else if(t.sheetsList){t.sheetsList.innerHTML='<h4 style="margin-bottom: 1rem;">Selecione uma planilha:</h4>';const o=document.createElement("div");o.style.cssText="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;",e.forEach(r=>{const c=document.createElement("button");c.className="button",c.style.cssText="width: 100%; text-align: left; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa; border: 1px solid #e0e0e0;";let S="";r.modifiedTime&&(S=new Date(r.modifiedTime).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})),c.innerHTML=`
            <div style="flex: 1; overflow: hidden;">
              <strong style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #333;">${r.name}</strong>
              <small style="color: #666; display: block;">Modificado: ${S||"N/A"}</small>
            </div>
            <span style="color: #27ae60; font-size: 1.2rem;">‚Üí</span>
          `,c.addEventListener("click",()=>T(r.id,r.name)),o.appendChild(c)}),t.sheetsList.appendChild(o),t.sheetsList.style.display="block"}t.loadSheetsButton&&(t.loadSheetsButton.disabled=!1,t.loadSheetsButton.textContent="üîÑ Recarregar Lista")}catch(e){console.error("‚ùå Erro ao listar planilhas:",e);let o="Erro ao listar planilhas. ";(a=e==null?void 0:e.data)!=null&&a.error?o+=e.data.error:e!=null&&e.message?o+=e.message:(e==null?void 0:e.status)===401?o+="Token de acesso expirado. Tente revogar e autorizar novamente.":(e==null?void 0:e.status)===404?o+="Autoriza√ß√£o com Google Drive n√£o encontrada. Autorize primeiro.":(e==null?void 0:e.status)===400?o+="Falha ao acessar Google Drive. Verifique se voc√™ autorizou corretamente e tente revogar e autorizar novamente se necess√°rio.":o+="Tente novamente.",l(o),t.loadSheetsButton&&(t.loadSheetsButton.disabled=!1,t.loadSheetsButton.textContent="üìã Carregar Minhas Planilhas")}}async function T(a,e){try{console.log(`üìã Selecionando planilha: ${e} (${a})`),await h.saveSheetId(a,e),console.log("‚úÖ Planilha selecionada com sucesso"),s.hasSheetId=!0,s.sheetId=a,s.sheetName=e,d(),g(`Planilha "${e}" selecionada com sucesso!`)}catch(o){console.error("‚ùå Erro ao selecionar planilha:",o),l((o==null?void 0:o.message)||"Erro ao selecionar planilha. Tente novamente.")}}async function B(){try{const a=n.authStore.record;if(!(a!=null&&a.id)){l("Usu√°rio n√£o autenticado.");return}console.log("üîë Iniciando fluxo OAuth..."),await E.startAuthFlow(a.id)}catch(a){console.error("‚ùå Erro ao iniciar OAuth:",a),l("Erro ao iniciar autoriza√ß√£o com Google.")}}async function b(){if(confirm(`Tem certeza que deseja revogar a autoriza√ß√£o do Google Drive?

Isso ir√°:
‚Ä¢ Remover todos os tokens de acesso
‚Ä¢ Limpar a configura√ß√£o da planilha
‚Ä¢ Ser√° necess√°rio autorizar novamente para usar o sistema

Deseja continuar?`))try{console.log("üö´ Revogando autoriza√ß√£o Google..."),t.revokeAuthButton&&(t.revokeAuthButton.disabled=!0,t.revokeAuthButton.textContent="‚è≥ Revogando..."),await h.revokeGoogleAccess(),console.log("‚úÖ Autoriza√ß√£o revogada com sucesso"),s.hasRefreshToken=!1,s.hasSheetId=!1,s.sheetId=void 0,s.sheetName=void 0,f(),d(),g(`Autoriza√ß√£o revogada com sucesso!

Para usar o sistema novamente, clique em "üîë Autorizar com Google" e fa√ßa login com sua conta Google.`),setTimeout(()=>{window.location.reload()},3e3)}catch(e){console.error("‚ùå Erro ao revogar autoriza√ß√£o:",e),l((e==null?void 0:e.message)||"Erro ao revogar autoriza√ß√£o. Tente novamente."),t.revokeAuthButton&&(t.revokeAuthButton.disabled=!1,t.revokeAuthButton.textContent="üö´ Revogar Autoriza√ß√£o")}}function I(){var a,e,o,r;(a=t.googleAuthButton)==null||a.addEventListener("click",B),(e=t.revokeAuthButton)==null||e.addEventListener("click",b),(o=t.createSheetButton)==null||o.addEventListener("click",A),(r=t.loadSheetsButton)==null||r.addEventListener("click",k)}async function p(){v(),I(),await w(),console.log("‚úÖ P√°gina de configura√ß√£o inicializada")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p();
